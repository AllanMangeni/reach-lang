<p>
  <i id="p_0" class="pid"></i>In this workshop, we'll look at yet another strategy for transferring funds, but in this version, we'll think about it as establishing a "trust fund": a funder will establish an account for the receiver, which they must wait a certain amount of time to access, and if they do not, then it reverts to the funder, and if the funder does not claim it, then it is dormant and any third party can remove the funds.
  You could think of this as a variant of the <a href="/workshop/relay/#workshop-relay">relay account</a>, with a mandatory waiting period and two fallbacks on <a href="/guide/timeout/#guide-timeout">non-participation</a>.<a href="#p_0" class="pid">0</a>
</p>
<div class="note">
  <p><i id="p_1" class="pid"></i>This workshop assumes that you have recently completed <a href="/workshop/relay/#workshop-relay">Relay Account</a>.<a href="#p_1" class="pid">1</a></p>
</div>
<p><i id="p_2" class="pid"></i>We assume that you'll go through this workshop in a directory named <code>~/reach/workshop-trust-fund</code>:<a href="#p_2" class="pid">2</a></p>
<pre class="snippet unnumbered"><div class="codeHeader">&nbsp;<a class="far fa-copy copyBtn" data-clipboard-text="$ mkdir -p ~/reach/workshop-trust-fund &amp;&amp; cd ~/reach/workshop-trust-fund" href="#"></a></div><ol class="snippet"><li value="1">$ mkdir -p ~/reach/workshop-trust-fund &amp;&amp; cd ~/reach/workshop-trust-fund</li></ol></pre>
<p><i id="p_3" class="pid"></i>And that you have a copy of Reach <a href="/tool/install/#ref-install">installed</a> in <code>~/reach</code> so you can write<a href="#p_3" class="pid">3</a></p>
<pre class="snippet unnumbered"><div class="codeHeader">&nbsp;<a class="far fa-copy copyBtn" data-clipboard-text="$ ../reach version" href="#"></a></div><ol class="snippet"><li value="1">$ ../reach version</li></ol></pre>
<p>
  <i id="p_4" class="pid"></i>And it will run Reach.
  You should start off by initializing your Reach program:<a href="#p_4" class="pid">4</a>
</p>
<pre class="snippet unnumbered"><div class="codeHeader">&nbsp;<a class="far fa-copy copyBtn" data-clipboard-text="$ ../reach init" href="#"></a></div><ol class="snippet"><li value="1">$ ../reach init</li></ol></pre>
<h2 id="workshop-trust-fund-pr" class="refHeader">Problem Analysis<a aria-hidden="true" tabindex="-1" href="#workshop-trust-fund-pr"><span class="icon icon-link"></span></a></h2>
<p><i id="p_5" class="pid"></i>For this workshop, we'll provide some constraints on your solution and problem analysis, since we'd like you to explore writing a Reach program with a specific design.<a href="#p_5" class="pid">5</a></p>
<p><i id="p_6" class="pid"></i>The overall purpose of this application is so that:<a href="#p_6" class="pid">6</a></p>
<ul>
  <li><i id="p_7" class="pid"></i>The Funder must decide an amount of funds to provide, as well as all of the other parameters of the application.<a href="#p_7" class="pid">7</a></li>
  <li><i id="p_8" class="pid"></i>The Funder will know the identity of the Receiver at the beginning.<a href="#p_8" class="pid">8</a></li>
  <li><i id="p_9" class="pid"></i>Whomever ultimately receives the funds transfers it to themselves.<a href="#p_9" class="pid">9</a></li>
</ul>
<p><i id="p_10" class="pid"></i>With this in mind, let's answer the questions:<a href="#p_10" class="pid">10</a></p>
<ul>
  <li><i id="p_11" class="pid"></i>What are the participants of the application?<a href="#p_11" class="pid">11</a></li>
  <li><i id="p_12" class="pid"></i>What information do they know at the start of the program?<a href="#p_12" class="pid">12</a></li>
  <li><i id="p_13" class="pid"></i>What information are they going to discover and use in the program?<a href="#p_13" class="pid">13</a></li>
  <li><i id="p_14" class="pid"></i>What funds change ownership during the application and how?<a href="#p_14" class="pid">14</a></li>
</ul>
<p><strong>Write down the problem analysis of this program as a comment.</strong></p>
<p><i id="p_15" class="pid"></i>Let's see how your answers compare to our answers:<a href="#p_15" class="pid">15</a></p>
<ul>
  <li><i id="p_16" class="pid"></i>This application involves three participants: the Funder, the Receiver, and a Bystander.<a href="#p_16" class="pid">16</a></li>
  <li><i id="p_17" class="pid"></i>The Funder knows the identity of the Receiver, the amount, as well as the maturity of the fund, and the delays before which it will be declared dormant or forsook.<a href="#p_17" class="pid">17</a></li>
  <li><i id="p_18" class="pid"></i>The Receiver and the Bystander don't learn or provide anything, aside from the existence of the fund and its maturity.<a href="#p_18" class="pid">18</a></li>
  <li><i id="p_19" class="pid"></i>The funds start with the Funder and then move to either the Receiver, the Funder, or the Bystander, depending on when they are claimed.<a href="#p_19" class="pid">19</a></li>
</ul>
<h2 id="workshop-trust-fund-dd" class="refHeader">Data Definition<a aria-hidden="true" tabindex="-1" href="#workshop-trust-fund-dd"><span class="icon icon-link"></span></a></h2>
<p>
  <i id="p_20" class="pid"></i>The next step of designing our program is representing this information in our program and deciding the participant interact interface for each participant.
  In this application, we'll be using a new concept of Reach: the time delta.
  The trust fund has a "maturity", as well as the lengths of time before which the fund is forsook or abandoned.
  In the fiat world, these would likely be expressed as real time durations, like months and years.
  However, on most consensus networks there is an abstraction of time into something like a "block height", which represents the number of rounds of consensus which have reached their conclusion.
  There is a loose relationship of these notions to real-time, but most networks do not guarantee any particular connection.
  (Indeed, such a connection between the abstract world of consensus networks and the "real" world is typically provided by an <a href="/workshop/#workshop-oracle">oracle</a>.)
  Reach abstracts the details of particular consensus networks away into the concept of a time delta, which is represented by an integer in Reach programs, and used in positions that reference time.<a href="#p_20" class="pid">20</a>
</p>
<p><i id="p_21" class="pid"></i>With that knowledge in hand,<a href="#p_21" class="pid">21</a></p>
<p><strong>Write down the data definitions for this program as definitions.</strong></p>
<p>
  <i id="p_22" class="pid"></i>Let's compare notes again.
  Here's what we wrote in our program:<a href="#p_22" class="pid">22</a>
</p>
<pre class="snippet numbered"><div class="codeHeader"><a href="https://github.com/reach-sh/reach-lang/tree/master/examples/workshop-trust-fund/index.rsh">/examples/workshop-trust-fund/index.rsh</a><a class="far fa-copy copyBtn" data-clipboard-text="'reach 0.1';

const common = {
  funded: Fun([], Null),
  ready : Fun([], Null),
  recvd : Fun([UInt], Null) };

export const main =
  Reach.App(
    {},
    [ Participant('Funder', {
      ...common,
      getParams: Fun([], Object({
        receiverAddr: Address,
        payment:      UInt,
        maturity:     UInt,
        refund:       UInt,
        dormant:      UInt })) }),
      Participant('Receiver', common),
      Participant('Bystander', common) ],
    (Funder, Receiver, Bystander) => {
      Funder.only(() => {
        const { receiverAddr,
                payment, maturity, refund, dormant }
              = declassify(interact.getParams()); });
      Funder.publish(
        receiverAddr,
        payment, maturity, refund, dormant )
        .pay(payment);
      Receiver.set(receiverAddr);
      commit();

      each([Funder, Receiver, Bystander], () => {
        interact.funded(); });
      wait(relativeTime(maturity));

      const giveChance = (Who, then) => {
        Who.only(() => interact.ready());

        if ( then ) {
          Who.publish()
            .timeout(relativeTime(then.deadline), () => then.after()); }
        else {
          Who.publish(); }

        transfer(payment).to(Who);
        commit();
        Who.only(() => interact.recvd(payment));
        exit(); };

      giveChance(
        Receiver,
        { deadline: refund,
          after: () =>
          giveChance(
            Funder,
            { deadline: dormant,
              after: () =>
              giveChance(Bystander, false) }) }); });" href="#"></a></div><ol class="snippet"><li value="1"><span style="color: #032F62">'reach 0.1'</span><span style="color: #24292E">;</span></li><li value="2"></li><li value="3"><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">common</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> {</span></li><li value="4"><span style="color: #24292E">  funded: </span><span style="color: #6F42C1">Fun</span><span style="color: #24292E">([], Null),</span></li><li value="5"><span style="color: #24292E">  ready : </span><span style="color: #6F42C1">Fun</span><span style="color: #24292E">([], Null),</span></li><li value="6"><span style="color: #24292E">  recvd : </span><span style="color: #6F42C1">Fun</span><span style="color: #24292E">([UInt], Null) };</span></li><li value="7"></li><li value="8"><span style="color: #D73A49">export</span><span style="color: #24292E"> </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">main</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span></li><li value="9"><span style="color: #24292E">  Reach.</span><span style="color: #6F42C1">App</span><span style="color: #24292E">(</span></li><li value="10"><span style="color: #24292E">    {},</span></li><li value="11"><span style="color: #24292E">    [ </span><span style="color: #6F42C1">Participant</span><span style="color: #24292E">(</span><span style="color: #032F62">'Funder'</span><span style="color: #24292E">, {</span></li><li value="12"><span style="color: #24292E">      </span><span style="color: #D73A49">...</span><span style="color: #24292E">common,</span></li><li value="13"><span style="color: #24292E">      getParams: </span><span style="color: #6F42C1">Fun</span><span style="color: #24292E">([], </span><span style="color: #005CC5">Object</span><span style="color: #24292E">({</span></li><li value="14"><span style="color: #24292E">        receiverAddr: Address,</span></li><li value="15"><span style="color: #24292E">        payment:      UInt,</span></li><li value="16"><span style="color: #24292E">        maturity:     UInt,</span></li><li value="17"><span style="color: #24292E">        refund:       UInt,</span></li><li value="18"><span style="color: #24292E">        dormant:      UInt })) }),</span></li><li value="19"><span style="color: #24292E">      </span><span style="color: #6F42C1">Participant</span><span style="color: #24292E">(</span><span style="color: #032F62">'Receiver'</span><span style="color: #24292E">, common),</span></li><li value="20"><span style="color: #24292E">      </span><span style="color: #6F42C1">Participant</span><span style="color: #24292E">(</span><span style="color: #032F62">'Bystander'</span><span style="color: #24292E">, common) ],</span></li><li value="21"><span style="color: #24292E">    (</span><span style="color: #E36209">Funder</span><span style="color: #24292E">, </span><span style="color: #E36209">Receiver</span><span style="color: #24292E">, </span><span style="color: #E36209">Bystander</span><span style="color: #24292E">) </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li></ol></pre>
<p><i id="p_23" class="pid"></i>We've represented most values as <span class="snip"><span style="color: #24292E">UInt</span></span> fields, and created a "common" interface that has a series of signals for the different phases of the application: one for when the account is <span class="snip"><span style="color: #24292E">funded</span></span>, one for when the particular participant is <span class="snip"><span style="color: #24292E">ready</span></span> to extract the funds, and finally one for when they have successfuly <span class="snip"><span style="color: #24292E">recvd</span></span> (received) them.<a href="#p_23" class="pid">23</a></p>
<h2 id="workshop-trust-fund-cc" class="refHeader">Communication Construction<a aria-hidden="true" tabindex="-1" href="#workshop-trust-fund-cc"><span class="icon icon-link"></span></a></h2>
<p>
  <i id="p_24" class="pid"></i>Now, we can write down the structure of communication and action in our application.
  Try this on your own based on your experience with <a href="/workshop/relay/#workshop-relay">Relay Account</a>.<a href="#p_24" class="pid">24</a>
</p>
<p><strong>Write down the communication pattern for this program as comments.</strong></p>
<p><i id="p_25" class="pid"></i>Here's what we wrote:<a href="#p_25" class="pid">25</a></p>
<pre class="snippet numbered"><div class="codeHeader">&nbsp;<a class="far fa-copy copyBtn" data-clipboard-text="// 1. The Funder publishes the parameters of the fund and makes the initial deposit.
// 2. The consensus remembers who the Receiver is.
// 3. Everyone waits for the fund to mature.
// 4. The Receiver may extract the funds with a deadline of `refund`.
// 5. The Funder may extract the funds with a deadline of `dormant`.
// 6. The Bystander may extract the funds with no deadline." href="#"></a></div><ol class="snippet"><li value="1"><span style="color: #6A737D">// 1. The Funder publishes the parameters of the fund and makes the initial deposit.</span></li><li value="2"><span style="color: #6A737D">// 2. The consensus remembers who the Receiver is.</span></li><li value="3"><span style="color: #6A737D">// 3. Everyone waits for the fund to mature.</span></li><li value="4"><span style="color: #6A737D">// 4. The Receiver may extract the funds with a deadline of `refund`.</span></li><li value="5"><span style="color: #6A737D">// 5. The Funder may extract the funds with a deadline of `dormant`.</span></li><li value="6"><span style="color: #6A737D">// 6. The Bystander may extract the funds with no deadline.</span></li></ol></pre>
<p>
  <i id="p_26" class="pid"></i>The next step is to convert this pattern into actual program code using <span class="snip"><span style="color: #24292E">publish</span></span>, <span class="snip"><span style="color: #24292E">pay</span></span>, and <span class="snip"><span style="color: #24292E">commit</span></span>.
  However, this program gives us the opportunity to look at a few more features of Reach.<a href="#p_26" class="pid">26</a>
</p>
<p>
  <i id="p_27" class="pid"></i>First, how do we implement step three, where each party waits for the fund to mature?
  Reach has a primitive named <span class="snip"><span style="color: #24292E">wait</span></span> which causes this to happen.
  This may only occur in a step, which is the same context where <span class="snip"><span style="color: #24292E">publish</span></span> may occur.
  This primitive, however, doesn't just cause the <em>participants</em> to wait, instead it guarantees that the entire computation waits.
  In other words, this means that the contract will ensure that the later steps do not occur until after the waiting time.<a href="#p_27" class="pid">27</a>
</p>
<p>
  <i id="p_28" class="pid"></i>Second, how do we implement steps four and five, where there is a deadline for an action to take place?
  Reach publication steps take an option called <span class="snip"><span style="color: #24292E">.timeout</span></span> that specifies an alternative computation to occur if the first does not take place before the deadline.
  The syntax looks like: <span class="snip"><span style="color: #6F42C1">publish</span><span style="color: #24292E">().</span><span style="color: #6F42C1">timeout</span><span style="color: #24292E">(deadline, () </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> alternative)</span></span>, which uses the arrow expression syntax for specifying the alternative computation.<a href="#p_28" class="pid">28</a>
</p>
<p>
  <i id="p_29" class="pid"></i>Finally, we hope you notice that steps four, five, and six are extremely similar.
  Consider trying to write a function that is used three times to implement all of them!<a href="#p_29" class="pid">29</a>
</p>
<p><strong>Write down the communication pattern for this program as code.</strong></p>
<p><i id="p_30" class="pid"></i>The body of your application should look something like:<a href="#p_30" class="pid">30</a></p>
<pre class="snippet numbered"><div class="codeHeader">&nbsp;<a class="far fa-copy copyBtn" data-clipboard-text="// 1. The Funder publishes the parameters of the fund and makes the initial deposit.
Funder.publish(receiverAddr, payment, maturity, refund, dormant )
  .pay(payment);

// 2. The consensus remembers who the Receiver is.
Receiver.set(receiverAddr);
commit();

// 3. Everyone waits for the fund to mature.
wait(maturity);

// 4. The Receiver may extract the funds with a deadline of `refund`.
Receiver.publish()
  .timeout(refund,
    () => {
     // 5. The Funder may extract the funds with a deadline of `dormant`.
      Funder.publish()
        .timeout(dormant,
          () => {
            // 6. The Bystander may extract the funds with no deadline.
            Bystander.publish();
            transfer(payment).to(Bystander);
            commit();
            exit(); });
       transfer(payment).to(Funder);
       commit();
       exit(); });
transfer(payment).to(Receiver);
commit();
exit();" href="#"></a></div><ol class="snippet"><li value="1"><span style="color: #6A737D">// 1. The Funder publishes the parameters of the fund and makes the initial deposit.</span></li><li value="2"><span style="color: #24292E">Funder.</span><span style="color: #6F42C1">publish</span><span style="color: #24292E">(receiverAddr, payment, maturity, refund, dormant )</span></li><li value="3"><span style="color: #24292E">  .</span><span style="color: #6F42C1">pay</span><span style="color: #24292E">(payment);</span></li><li value="4"></li><li value="5"><span style="color: #6A737D">// 2. The consensus remembers who the Receiver is.</span></li><li value="6"><span style="color: #24292E">Receiver.</span><span style="color: #6F42C1">set</span><span style="color: #24292E">(receiverAddr);</span></li><li value="7"><span style="color: #6F42C1">commit</span><span style="color: #24292E">();</span></li><li value="8"></li><li value="9"><span style="color: #6A737D">// 3. Everyone waits for the fund to mature.</span></li><li value="10"><span style="color: #6F42C1">wait</span><span style="color: #24292E">(maturity);</span></li><li value="11"></li><li value="12"><span style="color: #6A737D">// 4. The Receiver may extract the funds with a deadline of `refund`.</span></li><li value="13"><span style="color: #24292E">Receiver.</span><span style="color: #6F42C1">publish</span><span style="color: #24292E">()</span></li><li value="14"><span style="color: #24292E">  .</span><span style="color: #6F42C1">timeout</span><span style="color: #24292E">(refund,</span></li><li value="15"><span style="color: #24292E">    () </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="16"><span style="color: #24292E">     </span><span style="color: #6A737D">// 5. The Funder may extract the funds with a deadline of `dormant`.</span></li><li value="17"><span style="color: #24292E">      Funder.</span><span style="color: #6F42C1">publish</span><span style="color: #24292E">()</span></li><li value="18"><span style="color: #24292E">        .</span><span style="color: #6F42C1">timeout</span><span style="color: #24292E">(dormant,</span></li><li value="19"><span style="color: #24292E">          () </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="20"><span style="color: #24292E">            </span><span style="color: #6A737D">// 6. The Bystander may extract the funds with no deadline.</span></li><li value="21"><span style="color: #24292E">            Bystander.</span><span style="color: #6F42C1">publish</span><span style="color: #24292E">();</span></li><li value="22"><span style="color: #24292E">            </span><span style="color: #6F42C1">transfer</span><span style="color: #24292E">(payment).</span><span style="color: #6F42C1">to</span><span style="color: #24292E">(Bystander);</span></li><li value="23"><span style="color: #24292E">            </span><span style="color: #6F42C1">commit</span><span style="color: #24292E">();</span></li><li value="24"><span style="color: #24292E">            </span><span style="color: #6F42C1">exit</span><span style="color: #24292E">(); });</span></li><li value="25"><span style="color: #24292E">       </span><span style="color: #6F42C1">transfer</span><span style="color: #24292E">(payment).</span><span style="color: #6F42C1">to</span><span style="color: #24292E">(Funder);</span></li><li value="26"><span style="color: #24292E">       </span><span style="color: #6F42C1">commit</span><span style="color: #24292E">();</span></li><li value="27"><span style="color: #24292E">       </span><span style="color: #6F42C1">exit</span><span style="color: #24292E">(); });</span></li><li value="28"><span style="color: #6F42C1">transfer</span><span style="color: #24292E">(payment).</span><span style="color: #6F42C1">to</span><span style="color: #24292E">(Receiver);</span></li><li value="29"><span style="color: #6F42C1">commit</span><span style="color: #24292E">();</span></li><li value="30"><span style="color: #6F42C1">exit</span><span style="color: #24292E">();</span></li></ol></pre>
<div class="note">
  <p><i id="p_31" class="pid"></i>If you'd like to see how you might contain the repetition into a function, keep reading!<a href="#p_31" class="pid">31</a></p>
</div>
<h2 id="workshop-trust-fund-ai" class="refHeader">Assertion Insertion<a aria-hidden="true" tabindex="-1" href="#workshop-trust-fund-ai"><span class="icon icon-link"></span></a></h2>
<p>
  <i id="p_32" class="pid"></i>As usual, we should consider what assertions we can add to our program, but this program doesn't have any interesting properties to prove, so we'll move on.
  Or rather, all of its interesting properties are the ones automatically included in all Reach programs, like that the funds are used linearly and nothing is left over in the account at the end, or that the protocol steps must be received before the corresponding deadlines.<a href="#p_32" class="pid">32</a>
</p>
<h2 id="workshop-trust-fund-ii" class="refHeader">Interaction Introduction<a aria-hidden="true" tabindex="-1" href="#workshop-trust-fund-ii"><span class="icon icon-link"></span></a></h2>
<p>
  <i id="p_33" class="pid"></i>Next, we need to insert the appropriate calls to <span class="snip"><span style="color: #24292E">interact</span></span>.
  In this case, our program is very simple and we expect you'll do a great job without further discussion.
  However, if you want to simplify things, you might like to use <span class="snip"><span style="color: #24292E">each</span></span> to signal to all the parties that the account is funded, rather than duplicating the interaction code over and over.<a href="#p_33" class="pid">33</a>
</p>
<p><strong>Insert <code>interact</code> calls to the frontend into the program.</strong></p>
<p><i id="p_34" class="pid"></i>Let's look at our whole program now:<a href="#p_34" class="pid">34</a></p>
<pre class="snippet numbered"><div class="codeHeader"><a href="https://github.com/reach-sh/reach-lang/tree/master/examples/workshop-trust-fund/index.rsh">/examples/workshop-trust-fund/index.rsh</a><a class="far fa-copy copyBtn" data-clipboard-text="'reach 0.1';

const common = {
  funded: Fun([], Null),
  ready : Fun([], Null),
  recvd : Fun([UInt], Null) };

export const main =
  Reach.App(
    {},
    [ Participant('Funder', {
      ...common,
      getParams: Fun([], Object({
        receiverAddr: Address,
        payment:      UInt,
        maturity:     UInt,
        refund:       UInt,
        dormant:      UInt })) }),
      Participant('Receiver', common),
      Participant('Bystander', common) ],
    (Funder, Receiver, Bystander) => {
      Funder.only(() => {
        const { receiverAddr,
                payment, maturity, refund, dormant }
              = declassify(interact.getParams()); });
      Funder.publish(
        receiverAddr,
        payment, maturity, refund, dormant )
        .pay(payment);
      Receiver.set(receiverAddr);
      commit();

      each([Funder, Receiver, Bystander], () => {
        interact.funded(); });
      wait(relativeTime(maturity));

      const giveChance = (Who, then) => {
        Who.only(() => interact.ready());

        if ( then ) {
          Who.publish()
            .timeout(relativeTime(then.deadline), () => then.after()); }
        else {
          Who.publish(); }

        transfer(payment).to(Who);
        commit();
        Who.only(() => interact.recvd(payment));
        exit(); };

      giveChance(
        Receiver,
        { deadline: refund,
          after: () =>
          giveChance(
            Funder,
            { deadline: dormant,
              after: () =>
              giveChance(Bystander, false) }) }); });" href="#"></a></div><ol class="snippet"><li value="1"><span style="color: #032F62">'reach 0.1'</span><span style="color: #24292E">;</span></li><li value="2"></li><li value="3"><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">common</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> {</span></li><li value="4"><span style="color: #24292E">  funded: </span><span style="color: #6F42C1">Fun</span><span style="color: #24292E">([], Null),</span></li><li value="5"><span style="color: #24292E">  ready : </span><span style="color: #6F42C1">Fun</span><span style="color: #24292E">([], Null),</span></li><li value="6"><span style="color: #24292E">  recvd : </span><span style="color: #6F42C1">Fun</span><span style="color: #24292E">([UInt], Null) };</span></li><li value="7"></li><li value="8"><span style="color: #D73A49">export</span><span style="color: #24292E"> </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">main</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span></li><li value="9"><span style="color: #24292E">  Reach.</span><span style="color: #6F42C1">App</span><span style="color: #24292E">(</span></li><li value="10"><span style="color: #24292E">    {},</span></li><li value="11"><span style="color: #24292E">    [ </span><span style="color: #6F42C1">Participant</span><span style="color: #24292E">(</span><span style="color: #032F62">'Funder'</span><span style="color: #24292E">, {</span></li><li value="12"><span style="color: #24292E">      </span><span style="color: #D73A49">...</span><span style="color: #24292E">common,</span></li><li value="13"><span style="color: #24292E">      getParams: </span><span style="color: #6F42C1">Fun</span><span style="color: #24292E">([], </span><span style="color: #005CC5">Object</span><span style="color: #24292E">({</span></li><li value="14"><span style="color: #24292E">        receiverAddr: Address,</span></li><li value="15"><span style="color: #24292E">        payment:      UInt,</span></li><li value="16"><span style="color: #24292E">        maturity:     UInt,</span></li><li value="17"><span style="color: #24292E">        refund:       UInt,</span></li><li value="18"><span style="color: #24292E">        dormant:      UInt })) }),</span></li><li value="19"><span style="color: #24292E">      </span><span style="color: #6F42C1">Participant</span><span style="color: #24292E">(</span><span style="color: #032F62">'Receiver'</span><span style="color: #24292E">, common),</span></li><li value="20"><span style="color: #24292E">      </span><span style="color: #6F42C1">Participant</span><span style="color: #24292E">(</span><span style="color: #032F62">'Bystander'</span><span style="color: #24292E">, common) ],</span></li><li value="21"><span style="color: #24292E">    (</span><span style="color: #E36209">Funder</span><span style="color: #24292E">, </span><span style="color: #E36209">Receiver</span><span style="color: #24292E">, </span><span style="color: #E36209">Bystander</span><span style="color: #24292E">) </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="22"><span style="color: #24292E">      Funder.</span><span style="color: #6F42C1">only</span><span style="color: #24292E">(() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="23"><span style="color: #24292E">        </span><span style="color: #D73A49">const</span><span style="color: #24292E"> { </span><span style="color: #005CC5">receiverAddr</span><span style="color: #24292E">,</span></li><li value="24"><span style="color: #24292E">                </span><span style="color: #005CC5">payment</span><span style="color: #24292E">, </span><span style="color: #005CC5">maturity</span><span style="color: #24292E">, </span><span style="color: #005CC5">refund</span><span style="color: #24292E">, </span><span style="color: #005CC5">dormant</span><span style="color: #24292E"> }</span></li><li value="25"><span style="color: #24292E">              </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">declassify</span><span style="color: #24292E">(interact.</span><span style="color: #6F42C1">getParams</span><span style="color: #24292E">()); });</span></li><li value="26"><span style="color: #24292E">      Funder.</span><span style="color: #6F42C1">publish</span><span style="color: #24292E">(</span></li><li value="27"><span style="color: #24292E">        receiverAddr,</span></li><li value="28"><span style="color: #24292E">        payment, maturity, refund, dormant )</span></li><li value="29"><span style="color: #24292E">        .</span><span style="color: #6F42C1">pay</span><span style="color: #24292E">(payment);</span></li><li value="30"><span style="color: #24292E">      Receiver.</span><span style="color: #6F42C1">set</span><span style="color: #24292E">(receiverAddr);</span></li><li value="31"><span style="color: #24292E">      </span><span style="color: #6F42C1">commit</span><span style="color: #24292E">();</span></li><li value="32"></li><li value="33"><span style="color: #24292E">      </span><span style="color: #6F42C1">each</span><span style="color: #24292E">([Funder, Receiver, Bystander], () </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="34"><span style="color: #24292E">        interact.</span><span style="color: #6F42C1">funded</span><span style="color: #24292E">(); });</span></li><li value="35"><span style="color: #24292E">      </span><span style="color: #6F42C1">wait</span><span style="color: #24292E">(</span><span style="color: #6F42C1">relativeTime</span><span style="color: #24292E">(maturity));</span></li><li value="36"></li><li value="37"><span style="color: #24292E">      </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #6F42C1">giveChance</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> (</span><span style="color: #E36209">Who</span><span style="color: #24292E">, </span><span style="color: #E36209">then</span><span style="color: #24292E">) </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="38"><span style="color: #24292E">        Who.</span><span style="color: #6F42C1">only</span><span style="color: #24292E">(() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> interact.</span><span style="color: #6F42C1">ready</span><span style="color: #24292E">());</span></li><li value="39"></li><li value="40"><span style="color: #24292E">        </span><span style="color: #D73A49">if</span><span style="color: #24292E"> ( then ) {</span></li><li value="41"><span style="color: #24292E">          Who.</span><span style="color: #6F42C1">publish</span><span style="color: #24292E">()</span></li><li value="42"><span style="color: #24292E">            .</span><span style="color: #6F42C1">timeout</span><span style="color: #24292E">(</span><span style="color: #6F42C1">relativeTime</span><span style="color: #24292E">(then.deadline), () </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> then.</span><span style="color: #6F42C1">after</span><span style="color: #24292E">()); }</span></li><li value="43"><span style="color: #24292E">        </span><span style="color: #D73A49">else</span><span style="color: #24292E"> {</span></li><li value="44"><span style="color: #24292E">          Who.</span><span style="color: #6F42C1">publish</span><span style="color: #24292E">(); }</span></li><li value="45"></li><li value="46"><span style="color: #24292E">        </span><span style="color: #6F42C1">transfer</span><span style="color: #24292E">(payment).</span><span style="color: #6F42C1">to</span><span style="color: #24292E">(Who);</span></li><li value="47"><span style="color: #24292E">        </span><span style="color: #6F42C1">commit</span><span style="color: #24292E">();</span></li><li value="48"><span style="color: #24292E">        Who.</span><span style="color: #6F42C1">only</span><span style="color: #24292E">(() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> interact.</span><span style="color: #6F42C1">recvd</span><span style="color: #24292E">(payment));</span></li><li value="49"><span style="color: #24292E">        </span><span style="color: #6F42C1">exit</span><span style="color: #24292E">(); };</span></li><li value="50"></li><li value="51"><span style="color: #24292E">      </span><span style="color: #6F42C1">giveChance</span><span style="color: #24292E">(</span></li><li value="52"><span style="color: #24292E">        Receiver,</span></li><li value="53"><span style="color: #24292E">        { deadline: refund,</span></li><li value="54"><span style="color: #24292E">          </span><span style="color: #6F42C1">after</span><span style="color: #24292E">: () </span><span style="color: #D73A49">=&gt;</span></li><li value="55"><span style="color: #24292E">          </span><span style="color: #6F42C1">giveChance</span><span style="color: #24292E">(</span></li><li value="56"><span style="color: #24292E">            Funder,</span></li><li value="57"><span style="color: #24292E">            { deadline: dormant,</span></li><li value="58"><span style="color: #24292E">              </span><span style="color: #6F42C1">after</span><span style="color: #24292E">: () </span><span style="color: #D73A49">=&gt;</span></li><li value="59"><span style="color: #24292E">              </span><span style="color: #6F42C1">giveChance</span><span style="color: #24292E">(Bystander, </span><span style="color: #005CC5">false</span><span style="color: #24292E">) }) }); });</span></li></ol></pre>
<ul>
  <li><i id="p_35" class="pid"></i>Lines 33 and 34 use <span class="snip"><span style="color: #24292E">each</span></span> to run the same code block <span class="snip"><span style="color: #24292E">only</span></span> in each of the given participants.<a href="#p_35" class="pid">35</a></li>
  <li><i id="p_36" class="pid"></i>Lines 51 through 59 abstract the duplicate copied repeated structure of the program into three calls to the same function.<a href="#p_36" class="pid">36</a></li>
  <li><i id="p_37" class="pid"></i>Lines 37 through 49 define this function as one that abstracts over who is permitted to extract the funds and whether there is a deadline.<a href="#p_37" class="pid">37</a></li>
</ul>
<p>
  <i id="p_38" class="pid"></i>This program demonstrates some of the remarkable features of Reach: we were able to abstract away a pattern of communication into a function and use it repeatedly and in different ways.
  Behind the scenes, when Reach compiles this program into a contract, it will derive a four step protocol with implicit state to check that the appropriate participant takes their action only when allowed.<a href="#p_38" class="pid">38</a>
</p>
<h2 id="workshop-trust-fund-de" class="refHeader">Deployment Decisions<a aria-hidden="true" tabindex="-1" href="#workshop-trust-fund-de"><span class="icon icon-link"></span></a></h2>
<p>
  <i id="p_39" class="pid"></i>Next, it is time to test our program.
  As usual, we'll present a completely automated test deployment, rather than an interactive one.
  This means that we'll have to have our participants purposefully "miss" their deadlines so we can see that the timeouts and deadlines work correctly.
  We'll implement it by abstracting away the test into a function of two parameters: booleans that decide whether the Receiver and Funder (respectively) should miss their deadline.
  We'll implement this miss by using the standard library function <span class="snip"><span style="color: #24292E">stdlib.wait</span></span> which takes a time delta encoded as a number.
  This function is like <span class="snip"><span style="color: #24292E">wait</span></span>, except it is local only to a single participant and has no bearing on the rules of the application.
  It's just a convenience mechanism for allowing time to pass on the consensus network.<a href="#p_39" class="pid">39</a>
</p>
<p><i id="p_40" class="pid"></i>We highly recommend that you try to implement a test setup like this yourself; when you're done, scroll down to see our solution.<a href="#p_40" class="pid">40</a></p>
<p><strong>Decide how you will deploy and use this application.</strong></p>
<p><i id="p_41" class="pid"></i>Here's the JavaScript frontend we wrote:<a href="#p_41" class="pid">41</a></p>
<pre class="snippet numbered"><div class="codeHeader"><a href="https://github.com/reach-sh/reach-lang/tree/master/examples/workshop-trust-fund/index.mjs">/examples/workshop-trust-fund/index.mjs</a><a class="far fa-copy copyBtn" data-clipboard-text="import * as stdlib_loader from '@reach-sh/stdlib/loader.mjs';
import * as backend from './build/index.main.mjs';

const runDemo = async (delayReceiver, delayFunder) => {
  const stdlib = await stdlib_loader.loadStdlib();
  const getBalance = async (who) => stdlib.formatCurrency(
    await stdlib.balanceOf(who), 4,
  );

  const MATURITY = 10;
  const REFUND = 10;
  const DORMANT = 10;
  const fDelay = delayFunder ? MATURITY + REFUND + DORMANT + 1 : 0;
  const rDelay = delayReceiver ? MATURITY + REFUND + 1 : 0;
  console.log(`Begin demo with funder delay(${fDelay}) and receiver delay(${rDelay}).`);

  const common = (who, delay = 0) => ({
    funded: async () => {
      console.log(`${who} sees that the account is funded.`);
      if ( delay != 0 ) {
        console.log(`${who} begins to wait...`);
        await stdlib.wait(delay);
      }
    },
    ready : async () => console.log(`${who} is ready to receive the funds.`),
    recvd : async () => console.log(`${who} received the funds.`)
  });

  const startingBalance = stdlib.parseCurrency(100);

  const funder = await stdlib.newTestAccount(startingBalance);
  const receiver = await stdlib.newTestAccount(startingBalance);
  const bystander = await stdlib.newTestAccount(startingBalance);

  const ctcFunder = funder.deploy(backend);
  const ctcReceiver = receiver.attach(backend, ctcFunder.getInfo());
  const ctcBystander = bystander.attach(backend, ctcFunder.getInfo());

  await Promise.all([
    backend.Funder(ctcFunder, {
      ...common('Funder', fDelay),
      getParams: () => ({
        receiverAddr: receiver.networkAccount,
        payment: stdlib.parseCurrency(10),
        maturity: MATURITY,
        refund: REFUND,
        dormant: DORMANT,
      }),
    }),
    backend.Receiver(ctcReceiver, common('Receiver', rDelay)),
    backend.Bystander(ctcBystander, common('Bystander')),
  ]);
  for (const [who, acc] of [['Funder', funder], ['Receiver', receiver], ['Bystander', bystander]]) {
    console.log(`${who} has a balance of ${await getBalance(acc)}`);
  }
  console.log(`\n`);
};

(async () => {
  await runDemo(false, false);
  await runDemo(true, false);
  await runDemo(true, true);
})();" href="#"></a></div><ol class="snippet"><li value="1"><span style="color: #D73A49">import</span><span style="color: #24292E"> </span><span style="color: #005CC5">*</span><span style="color: #24292E"> </span><span style="color: #D73A49">as</span><span style="color: #24292E"> stdlib_loader </span><span style="color: #D73A49">from</span><span style="color: #24292E"> </span><span style="color: #032F62">'@reach-sh/stdlib/loader.mjs'</span><span style="color: #24292E">;</span></li><li value="2"><span style="color: #D73A49">import</span><span style="color: #24292E"> </span><span style="color: #005CC5">*</span><span style="color: #24292E"> </span><span style="color: #D73A49">as</span><span style="color: #24292E"> backend </span><span style="color: #D73A49">from</span><span style="color: #24292E"> </span><span style="color: #032F62">'./build/index.main.mjs'</span><span style="color: #24292E">;</span></li><li value="3"></li><li value="4"><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #6F42C1">runDemo</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">async</span><span style="color: #24292E"> (</span><span style="color: #E36209">delayReceiver</span><span style="color: #24292E">, </span><span style="color: #E36209">delayFunder</span><span style="color: #24292E">) </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="5"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">stdlib</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">await</span><span style="color: #24292E"> stdlib_loader.</span><span style="color: #6F42C1">loadStdlib</span><span style="color: #24292E">();</span></li><li value="6"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #6F42C1">getBalance</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">async</span><span style="color: #24292E"> (</span><span style="color: #E36209">who</span><span style="color: #24292E">) </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> stdlib.</span><span style="color: #6F42C1">formatCurrency</span><span style="color: #24292E">(</span></li><li value="7"><span style="color: #24292E">    </span><span style="color: #D73A49">await</span><span style="color: #24292E"> stdlib.</span><span style="color: #6F42C1">balanceOf</span><span style="color: #24292E">(who), </span><span style="color: #005CC5">4</span><span style="color: #24292E">,</span></li><li value="8"><span style="color: #24292E">  );</span></li><li value="9"></li><li value="10"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">MATURITY</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">10</span><span style="color: #24292E">;</span></li><li value="11"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">REFUND</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">10</span><span style="color: #24292E">;</span></li><li value="12"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">DORMANT</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">10</span><span style="color: #24292E">;</span></li><li value="13"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">fDelay</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> delayFunder </span><span style="color: #D73A49">?</span><span style="color: #24292E"> </span><span style="color: #005CC5">MATURITY</span><span style="color: #24292E"> </span><span style="color: #D73A49">+</span><span style="color: #24292E"> </span><span style="color: #005CC5">REFUND</span><span style="color: #24292E"> </span><span style="color: #D73A49">+</span><span style="color: #24292E"> </span><span style="color: #005CC5">DORMANT</span><span style="color: #24292E"> </span><span style="color: #D73A49">+</span><span style="color: #24292E"> </span><span style="color: #005CC5">1</span><span style="color: #24292E"> </span><span style="color: #D73A49">:</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></li><li value="14"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">rDelay</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> delayReceiver </span><span style="color: #D73A49">?</span><span style="color: #24292E"> </span><span style="color: #005CC5">MATURITY</span><span style="color: #24292E"> </span><span style="color: #D73A49">+</span><span style="color: #24292E"> </span><span style="color: #005CC5">REFUND</span><span style="color: #24292E"> </span><span style="color: #D73A49">+</span><span style="color: #24292E"> </span><span style="color: #005CC5">1</span><span style="color: #24292E"> </span><span style="color: #D73A49">:</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">;</span></li><li value="15"><span style="color: #24292E">  console.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(</span><span style="color: #032F62">`Begin demo with funder delay(${</span><span style="color: #24292E">fDelay</span><span style="color: #032F62">}) and receiver delay(${</span><span style="color: #24292E">rDelay</span><span style="color: #032F62">}).`</span><span style="color: #24292E">);</span></li><li value="16"></li><li value="17"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #6F42C1">common</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> (</span><span style="color: #E36209">who</span><span style="color: #24292E">, </span><span style="color: #E36209">delay</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E">) </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> ({</span></li><li value="18"><span style="color: #24292E">    </span><span style="color: #6F42C1">funded</span><span style="color: #24292E">: </span><span style="color: #D73A49">async</span><span style="color: #24292E"> () </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="19"><span style="color: #24292E">      console.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(</span><span style="color: #032F62">`${</span><span style="color: #24292E">who</span><span style="color: #032F62">} sees that the account is funded.`</span><span style="color: #24292E">);</span></li><li value="20"><span style="color: #24292E">      </span><span style="color: #D73A49">if</span><span style="color: #24292E"> ( delay </span><span style="color: #D73A49">!=</span><span style="color: #24292E"> </span><span style="color: #005CC5">0</span><span style="color: #24292E"> ) {</span></li><li value="21"><span style="color: #24292E">        console.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(</span><span style="color: #032F62">`${</span><span style="color: #24292E">who</span><span style="color: #032F62">} begins to wait...`</span><span style="color: #24292E">);</span></li><li value="22"><span style="color: #24292E">        </span><span style="color: #D73A49">await</span><span style="color: #24292E"> stdlib.</span><span style="color: #6F42C1">wait</span><span style="color: #24292E">(delay);</span></li><li value="23"><span style="color: #24292E">      }</span></li><li value="24"><span style="color: #24292E">    },</span></li><li value="25"><span style="color: #24292E">    </span><span style="color: #6F42C1">ready</span><span style="color: #24292E"> : </span><span style="color: #D73A49">async</span><span style="color: #24292E"> () </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> console.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(</span><span style="color: #032F62">`${</span><span style="color: #24292E">who</span><span style="color: #032F62">} is ready to receive the funds.`</span><span style="color: #24292E">),</span></li><li value="26"><span style="color: #24292E">    </span><span style="color: #6F42C1">recvd</span><span style="color: #24292E"> : </span><span style="color: #D73A49">async</span><span style="color: #24292E"> () </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> console.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(</span><span style="color: #032F62">`${</span><span style="color: #24292E">who</span><span style="color: #032F62">} received the funds.`</span><span style="color: #24292E">)</span></li><li value="27"><span style="color: #24292E">  });</span></li><li value="28"></li><li value="29"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">startingBalance</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> stdlib.</span><span style="color: #6F42C1">parseCurrency</span><span style="color: #24292E">(</span><span style="color: #005CC5">100</span><span style="color: #24292E">);</span></li><li value="30"></li><li value="31"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">funder</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">await</span><span style="color: #24292E"> stdlib.</span><span style="color: #6F42C1">newTestAccount</span><span style="color: #24292E">(startingBalance);</span></li><li value="32"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">receiver</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">await</span><span style="color: #24292E"> stdlib.</span><span style="color: #6F42C1">newTestAccount</span><span style="color: #24292E">(startingBalance);</span></li><li value="33"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">bystander</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">await</span><span style="color: #24292E"> stdlib.</span><span style="color: #6F42C1">newTestAccount</span><span style="color: #24292E">(startingBalance);</span></li><li value="34"></li><li value="35"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">ctcFunder</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> funder.</span><span style="color: #6F42C1">deploy</span><span style="color: #24292E">(backend);</span></li><li value="36"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">ctcReceiver</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> receiver.</span><span style="color: #6F42C1">attach</span><span style="color: #24292E">(backend, ctcFunder.</span><span style="color: #6F42C1">getInfo</span><span style="color: #24292E">());</span></li><li value="37"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">ctcBystander</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> bystander.</span><span style="color: #6F42C1">attach</span><span style="color: #24292E">(backend, ctcFunder.</span><span style="color: #6F42C1">getInfo</span><span style="color: #24292E">());</span></li><li value="38"></li><li value="39"><span style="color: #24292E">  </span><span style="color: #D73A49">await</span><span style="color: #24292E"> </span><span style="color: #005CC5">Promise</span><span style="color: #24292E">.</span><span style="color: #6F42C1">all</span><span style="color: #24292E">([</span></li><li value="40"><span style="color: #24292E">    backend.</span><span style="color: #6F42C1">Funder</span><span style="color: #24292E">(ctcFunder, {</span></li><li value="41"><span style="color: #24292E">      </span><span style="color: #D73A49">...</span><span style="color: #6F42C1">common</span><span style="color: #24292E">(</span><span style="color: #032F62">'Funder'</span><span style="color: #24292E">, fDelay),</span></li><li value="42"><span style="color: #24292E">      </span><span style="color: #6F42C1">getParams</span><span style="color: #24292E">: () </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> ({</span></li><li value="43"><span style="color: #24292E">        receiverAddr: receiver.networkAccount,</span></li><li value="44"><span style="color: #24292E">        payment: stdlib.</span><span style="color: #6F42C1">parseCurrency</span><span style="color: #24292E">(</span><span style="color: #005CC5">10</span><span style="color: #24292E">),</span></li><li value="45"><span style="color: #24292E">        maturity: </span><span style="color: #005CC5">MATURITY</span><span style="color: #24292E">,</span></li><li value="46"><span style="color: #24292E">        refund: </span><span style="color: #005CC5">REFUND</span><span style="color: #24292E">,</span></li><li value="47"><span style="color: #24292E">        dormant: </span><span style="color: #005CC5">DORMANT</span><span style="color: #24292E">,</span></li><li value="48"><span style="color: #24292E">      }),</span></li><li value="49"><span style="color: #24292E">    }),</span></li><li value="50"><span style="color: #24292E">    backend.</span><span style="color: #6F42C1">Receiver</span><span style="color: #24292E">(ctcReceiver, </span><span style="color: #6F42C1">common</span><span style="color: #24292E">(</span><span style="color: #032F62">'Receiver'</span><span style="color: #24292E">, rDelay)),</span></li><li value="51"><span style="color: #24292E">    backend.</span><span style="color: #6F42C1">Bystander</span><span style="color: #24292E">(ctcBystander, </span><span style="color: #6F42C1">common</span><span style="color: #24292E">(</span><span style="color: #032F62">'Bystander'</span><span style="color: #24292E">)),</span></li><li value="52"><span style="color: #24292E">  ]);</span></li><li value="53"><span style="color: #24292E">  </span><span style="color: #D73A49">for</span><span style="color: #24292E"> (</span><span style="color: #D73A49">const</span><span style="color: #24292E"> [</span><span style="color: #005CC5">who</span><span style="color: #24292E">, </span><span style="color: #005CC5">acc</span><span style="color: #24292E">] </span><span style="color: #D73A49">of</span><span style="color: #24292E"> [[</span><span style="color: #032F62">'Funder'</span><span style="color: #24292E">, funder], [</span><span style="color: #032F62">'Receiver'</span><span style="color: #24292E">, receiver], [</span><span style="color: #032F62">'Bystander'</span><span style="color: #24292E">, bystander]]) {</span></li><li value="54"><span style="color: #24292E">    console.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(</span><span style="color: #032F62">`${</span><span style="color: #24292E">who</span><span style="color: #032F62">} has a balance of ${</span><span style="color: #D73A49">await</span><span style="color: #032F62"> </span><span style="color: #6F42C1">getBalance</span><span style="color: #032F62">(</span><span style="color: #24292E">acc</span><span style="color: #032F62">)</span><span style="color: #032F62">}`</span><span style="color: #24292E">);</span></li><li value="55"><span style="color: #24292E">  }</span></li><li value="56"><span style="color: #24292E">  console.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(</span><span style="color: #032F62">`</span><span style="color: #005CC5">\n</span><span style="color: #032F62">`</span><span style="color: #24292E">);</span></li><li value="57"><span style="color: #24292E">};</span></li><li value="58"></li><li value="59"><span style="color: #24292E">(</span><span style="color: #D73A49">async</span><span style="color: #24292E"> () </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="60"><span style="color: #24292E">  </span><span style="color: #D73A49">await</span><span style="color: #24292E"> </span><span style="color: #6F42C1">runDemo</span><span style="color: #24292E">(</span><span style="color: #005CC5">false</span><span style="color: #24292E">, </span><span style="color: #005CC5">false</span><span style="color: #24292E">);</span></li><li value="61"><span style="color: #24292E">  </span><span style="color: #D73A49">await</span><span style="color: #24292E"> </span><span style="color: #6F42C1">runDemo</span><span style="color: #24292E">(</span><span style="color: #005CC5">true</span><span style="color: #24292E">, </span><span style="color: #005CC5">false</span><span style="color: #24292E">);</span></li><li value="62"><span style="color: #24292E">  </span><span style="color: #D73A49">await</span><span style="color: #24292E"> </span><span style="color: #6F42C1">runDemo</span><span style="color: #24292E">(</span><span style="color: #005CC5">true</span><span style="color: #24292E">, </span><span style="color: #005CC5">true</span><span style="color: #24292E">);</span></li><li value="63"><span style="color: #24292E">})();</span></li></ol></pre>
<p><i id="p_42" class="pid"></i>The most interesting part of this program is on lines 20 through 23 when we optionally cause a delay in the participant after they receive the signal that the account is funded.<a href="#p_42" class="pid">42</a></p>
<p><i id="p_43" class="pid"></i>Let's see what it looks like when we run this program:<a href="#p_43" class="pid">43</a></p>
<pre class="snippet numbered"><div class="codeHeader">&nbsp;<a class="far fa-copy copyBtn" data-clipboard-text="$ ../reach run
Begin demo with funder delay(0) and receiver delay(0).
Receiver sees that the account is funded.
Bystander sees that the account is funded.
Funder sees that the account is funded.
Receiver is ready to receive the funds.
Receiver received the funds.
Funder has a balance of 89.99926093
Receiver has a balance of 109.999956574
Bystander has a balance of 100.0

Begin demo with funder delay(0) and receiver delay(21).
Receiver sees that the account is funded.
Receiver begins to wait...
Bystander sees that the account is funded.
Funder sees that the account is funded.
Funder is ready to receive the funds.
Receiver is ready to receive the funds.
Funder received the funds.
Funder has a balance of 99.999217452
Receiver has a balance of 99.99995488
Bystander has a balance of 100.0

Begin demo with funder delay(31) and receiver delay(21).
Receiver sees that the account is funded.
Receiver begins to wait...
Bystander sees that the account is funded.
Funder sees that the account is funded.
Funder begins to wait...
Receiver is ready to receive the funds.
Bystander is ready to receive the funds.
Funder is ready to receive the funds.
Bystander received the funds.
Funder has a balance of 89.99921581
Receiver has a balance of 100.0
Bystander has a balance of 109.999956956" href="#"></a></div><ol class="snippet"><li value="1">$ ../reach run</li><li value="2">Begin demo with funder delay(0) and receiver delay(0).</li><li value="3">Receiver sees that the account is funded.</li><li value="4">Bystander sees that the account is funded.</li><li value="5">Funder sees that the account is funded.</li><li value="6">Receiver is ready to receive the funds.</li><li value="7">Receiver received the funds.</li><li value="8">Funder has a balance of 89.99926093</li><li value="9">Receiver has a balance of 109.999956574</li><li value="10">Bystander has a balance of 100.0</li><li value="11"></li><li value="12">Begin demo with funder delay(0) and receiver delay(21).</li><li value="13">Receiver sees that the account is funded.</li><li value="14">Receiver begins to wait...</li><li value="15">Bystander sees that the account is funded.</li><li value="16">Funder sees that the account is funded.</li><li value="17">Funder is ready to receive the funds.</li><li value="18">Receiver is ready to receive the funds.</li><li value="19">Funder received the funds.</li><li value="20">Funder has a balance of 99.999217452</li><li value="21">Receiver has a balance of 99.99995488</li><li value="22">Bystander has a balance of 100.0</li><li value="23"></li><li value="24">Begin demo with funder delay(31) and receiver delay(21).</li><li value="25">Receiver sees that the account is funded.</li><li value="26">Receiver begins to wait...</li><li value="27">Bystander sees that the account is funded.</li><li value="28">Funder sees that the account is funded.</li><li value="29">Funder begins to wait...</li><li value="30">Receiver is ready to receive the funds.</li><li value="31">Bystander is ready to receive the funds.</li><li value="32">Funder is ready to receive the funds.</li><li value="33">Bystander received the funds.</li><li value="34">Funder has a balance of 89.99921581</li><li value="35">Receiver has a balance of 100.0</li><li value="36">Bystander has a balance of 109.999956956</li></ol></pre>
<h2 id="workshop-trust-fund-dns" class="refHeader">Discussion and Next Steps<a aria-hidden="true" tabindex="-1" href="#workshop-trust-fund-dns"><span class="icon icon-link"></span></a></h2>
<p>
  <i id="p_44" class="pid"></i>Great job!
  You could use this application today and start putting your child's college funds away for safe keeping!
  Although, perhaps you should wait until you read the workshop about interest-bearing accounts like this.<a href="#p_44" class="pid">44</a>
</p>
<p><i id="p_45" class="pid"></i>If you found this workshop rewarding, please let us know on <a href="https://discord.gg/AZsgcXu">the Discord community</a>!<a href="#p_45" class="pid">45</a></p>
<p>
  <i id="p_46" class="pid"></i>If you'd like to make this application a little more interesting, maybe you'd like to have a secret password just like <a href="/workshop/hash-lock/#workshop-hash-lock">the hash lock</a> as well, so the Funder can separate the revealing of information to Receiver.
  Similarly, you could make it like <a href="/workshop/relay/#workshop-relay">a relay account</a> and have the Receiver generated by the Funder and allow the Receiver to specify a third-party (fourth-party) to receive the actual funds.<a href="#p_46" class="pid">46</a>
</p>
<p>
  <i id="p_47" class="pid"></i>We recommend that you take a pause from workshops like this and revisit the <em>Rock, Paper, Scissors!</em> application in the <a href="/workshop/#workshop-rps-fair">fairness workshop</a>.
  Why don't you check it out?<a href="#p_47" class="pid">47</a>
</p>