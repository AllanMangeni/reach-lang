<p>
  <i id="p_0" class="pid"></i>In this workshop, we will extend our <a href="/workshop/fomo/#workshop-fomo">Fear of Missing Out application</a>
  with the ability to split the reward between the <code>N</code> most recent Buyers.<a href="#p_0" class="pid">0</a>
</p>
<p>
  <i id="p_1" class="pid"></i>In this version, the Funder will have the advantage that, if there are less than
  <code>N</code> Buyers, the Funder will earn the rewards for every absent Buyer. For example,
  if the auction is set to have 5 winners, yet only 3 Buyers bid, the first three Buyers
  will receive 1/5 of the funds each, and the Funder will receive the remaining 2/5 of the funds.<a href="#p_1" class="pid">1</a>
</p>
<div class="note">
  <p><i id="p_2" class="pid"></i>This workshop assumes that you have recently completed <a href="/workshop/fomo/#workshop-fomo">Fear of Missing Out</a>.<a href="#p_2" class="pid">2</a></p>
</div>
<p><i id="p_3" class="pid"></i>We assume that you'll go through this workshop in a directory named <code>~/reach/workshop-fomo-generalized</code>:<a href="#p_3" class="pid">3</a></p>
<pre class="snippet unnumbered"><div class="codeHeader">&nbsp;<a class="far fa-copy copyBtn" data-clipboard-text="$ mkdir -p ~/reach/workshop-fomo-generalized &amp;&amp; cd ~/reach/workshop-fomo-generalized" href="#"></a></div><ol class="snippet"><li value="1">$ mkdir -p ~/reach/workshop-fomo-generalized &amp;&amp; cd ~/reach/workshop-fomo-generalized</li></ol></pre>
<p><i id="p_4" class="pid"></i>And that you have a copy of Reach <a href="/tool/install/#ref-install">installed</a> in <code>~/reach</code> so you can write<a href="#p_4" class="pid">4</a></p>
<pre class="snippet unnumbered"><div class="codeHeader">&nbsp;<a class="far fa-copy copyBtn" data-clipboard-text="$ ../reach version" href="#"></a></div><ol class="snippet"><li value="1">$ ../reach version</li></ol></pre>
<p>
  <i id="p_5" class="pid"></i>And it will run Reach.
  You should start off by initializing your Reach program:<a href="#p_5" class="pid">5</a>
</p>
<pre class="snippet unnumbered"><div class="codeHeader">&nbsp;<a class="far fa-copy copyBtn" data-clipboard-text="$ ../reach init" href="#"></a></div><ol class="snippet"><li value="1">$ ../reach init</li></ol></pre>
<h2 id="workshop-fomo-generalized-pr" class="refHeader">Problem Analysis<a aria-hidden="true" tabindex="-1" href="#workshop-fomo-generalized-pr"><span class="icon icon-link"></span></a></h2>
<p>
  <i id="p_6" class="pid"></i>Our problem analysis is practically the same as the original Fear of Missing Out application,
  except for one difference:<a href="#p_6" class="pid">6</a>
</p>
<ul>
  <li><i id="p_7" class="pid"></i>What funds change ownership during the application and how?<a href="#p_7" class="pid">7</a></li>
</ul>
<p><strong>Write down the problem analysis of this program as a comment.</strong></p>
<p><i id="p_8" class="pid"></i>Let's compare answers for how funds should change ownership in this generalized version:<a href="#p_8" class="pid">8</a></p>
<ul>
  <li><i id="p_9" class="pid"></i>Buyers continually add funds to the balance during execution until the last <code>N</code> Buyers, and potentially the Funder, split the balance.<a href="#p_9" class="pid">9</a></li>
</ul>
<h2 id="workshop-fomo-generalized-dd" class="refHeader">Data Definition<a aria-hidden="true" tabindex="-1" href="#workshop-fomo-generalized-dd"><span class="icon icon-link"></span></a></h2>
<p>
  <i id="p_10" class="pid"></i>The data type representation of this program will basically be the same as the
  regular Fear of Missing Out program. However, instead of tracking the latest Buyer as an
  <span class="snip"><span style="color: #24292E">Address</span></span>, we will track the last <code>N</code> Buyers as an <span class="snip"><span style="color: #005CC5">Array</span><span style="color: #24292E">(Address, </span><span style="color: #005CC5">N</span><span style="color: #24292E">)</span></span>.<a href="#p_10" class="pid">10</a>
</p>
<div class="note">
  <p><i id="p_11" class="pid"></i>Refer to <a href="/rsh/compute/#ref-programs-types">Types</a> for a reminder of what data types are available in Reach.<a href="#p_11" class="pid">11</a></p>
</div>
<p><i id="p_12" class="pid"></i>You should take the time now to fill out the interaction interface for the participants.<a href="#p_12" class="pid">12</a></p>
<p><strong>Write down the data definitions for this program as definitions.</strong></p>
<p><i id="p_13" class="pid"></i>Our participant interact interface, with the addition of some handy logging functions, looks like this so far:<a href="#p_13" class="pid">13</a></p>
<div class="note">
  <p>
    <i id="p_14" class="pid"></i>It is worth noting that Reach does not support arbitrarily sized arrays, so we
    could not determine <code>NUM_OF_WINNERS</code> at runtime, e.g. from the interaction interface.
    However, we can still write a program that is generic in the size of the array, then
    specialize it when we compile.<a href="#p_14" class="pid">14</a>
  </p>
</div>
<pre class="snippet numbered"><div class="codeHeader"><a href="https://github.com/reach-sh/reach-lang/tree/master/examples/workshop-fomo-generalized/index.rsh">/examples/workshop-fomo-generalized/index.rsh</a><a class="far fa-copy copyBtn" data-clipboard-text="'reach 0.1';
'use strict';

// FOMO Workshop generalized to last N winners
const NUM_OF_WINNERS = 3;

const CommonInterface = {
  showOutcome: Fun([Array(Address, NUM_OF_WINNERS)], Null),
};

const FunderInterface = {
  ...CommonInterface,
  getParams: Fun([], Object({
    deadline: UInt, // relative deadline
    ticketPrice: UInt,
  })),
};

const BuyerInterface = {
  ...CommonInterface,
  shouldBuyTicket: Fun([UInt], Bool),
  showPurchase: Fun([Address], Null),
};

export const main = Reach.App(
  { },
  [
    Participant('Funder', FunderInterface), ParticipantClass('Buyer', BuyerInterface),
  ],
  (Funder, Buyer) => {
    const showOutcome = (winners) =>
      each([Funder, Buyer], () => interact.showOutcome(winners));

    Funder.only(() => {
      const { ticketPrice, deadline } = declassify(interact.getParams()); });
    Funder.publish(ticketPrice, deadline);

    const initialWinners = Array.replicate(NUM_OF_WINNERS, Funder);

    // Until deadline, allow buyers to buy ticket
    const [ keepGoing, winners, ticketsSold ] =
      parallelReduce([ true, initialWinners, 0 ])
        .invariant(balance() == ticketsSold * ticketPrice)
        .while(keepGoing)
        .case(
          Buyer,
          () => ({
            when: declassify(interact.shouldBuyTicket(ticketPrice)) }),
          (_) => ticketPrice,
          (_) => {
            const buyer = this;
            Buyer.only(() => interact.showPurchase(buyer));
            const idx = ticketsSold % NUM_OF_WINNERS;
            const newWinners =
              Array.set(winners, idx, buyer);
            return [ true, newWinners, ticketsSold + 1 ]; })
        .timeout(relativeTime(deadline), () => {
          Anybody.publish();
          return [ false, winners, ticketsSold ]; });

    transfer(balance() % NUM_OF_WINNERS).to(Funder);
    const reward = balance() / NUM_OF_WINNERS;

    winners.forEach(winner =>
      transfer(reward).to(winner));

    commit();
    showOutcome(winners);
  });" href="#"></a></div><ol class="snippet"><li value="5"><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">NUM_OF_WINNERS</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">3</span><span style="color: #24292E">;</span></li><li value="6"></li><li value="7"><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">CommonInterface</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> {</span></li><li value="8"><span style="color: #24292E">  showOutcome: </span><span style="color: #6F42C1">Fun</span><span style="color: #24292E">([</span><span style="color: #005CC5">Array</span><span style="color: #24292E">(Address, </span><span style="color: #005CC5">NUM_OF_WINNERS</span><span style="color: #24292E">)], Null),</span></li><li value="9"><span style="color: #24292E">};</span></li><li value="10"></li><li value="11"><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">FunderInterface</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> {</span></li><li value="12"><span style="color: #24292E">  </span><span style="color: #D73A49">...</span><span style="color: #24292E">CommonInterface,</span></li><li value="13"><span style="color: #24292E">  getParams: </span><span style="color: #6F42C1">Fun</span><span style="color: #24292E">([], </span><span style="color: #005CC5">Object</span><span style="color: #24292E">({</span></li><li value="14"><span style="color: #24292E">    deadline: UInt, </span><span style="color: #6A737D">// relative deadline</span></li><li value="15"><span style="color: #24292E">    ticketPrice: UInt,</span></li><li value="16"><span style="color: #24292E">  })),</span></li><li value="17"><span style="color: #24292E">};</span></li><li value="18"></li><li value="19"><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">BuyerInterface</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> {</span></li><li value="20"><span style="color: #24292E">  </span><span style="color: #D73A49">...</span><span style="color: #24292E">CommonInterface,</span></li><li value="21"><span style="color: #24292E">  shouldBuyTicket: </span><span style="color: #6F42C1">Fun</span><span style="color: #24292E">([UInt], Bool),</span></li><li value="22"><span style="color: #24292E">  showPurchase: </span><span style="color: #6F42C1">Fun</span><span style="color: #24292E">([Address], Null),</span></li><li value="23"><span style="color: #24292E">};</span></li></ol></pre>
<p>
  <i id="p_15" class="pid"></i>At this point, you can modify your JavaScript file (<code>index.mjs</code>) to contain definitions of these values, although you may want to use placeholders for the actual values.
  When you're writing a Reach program, especially in the early phases, you should have these two files open side-by-side and update them in tandem as you're deciding the participant interact interface.<a href="#p_15" class="pid">15</a>
</p>
<h2 id="workshop-fomo-generalized-cc" class="refHeader">Communication Construction<a aria-hidden="true" tabindex="-1" href="#workshop-fomo-generalized-cc"><span class="icon icon-link"></span></a></h2>
<p>
  <i id="p_16" class="pid"></i>A fundamental aspect of a decentralized application is the pattern of communication
  and transfer among the participants. We should write down this structure as comments
  in our program to serve as an outline and guide us in implementation. In our original Fear of Missing Out implementation, we outlined the pattern of communication as follows:<a href="#p_16" class="pid">16</a>
</p>
<pre class="snippet numbered"><div class="codeHeader">&nbsp;<a class="far fa-copy copyBtn" data-clipboard-text="// 1. The Funder publishes the ticket price and deadline
// 2. While the deadline has yet to be reached:
//     2a. Allow a Buyer to purchase a ticket
//     2b. Keep track of last Buyer
// 3. Transfer the balance to the last person who bought a ticket" href="#"></a></div><ol class="snippet"><li value="1"><span style="color: #6A737D">// 1. The Funder publishes the ticket price and deadline</span></li><li value="2"><span style="color: #6A737D">// 2. While the deadline has yet to be reached:</span></li><li value="3"><span style="color: #6A737D">//     2a. Allow a Buyer to purchase a ticket</span></li><li value="4"><span style="color: #6A737D">//     2b. Keep track of last Buyer</span></li><li value="5"><span style="color: #6A737D">// 3. Transfer the balance to the last person who bought a ticket</span></li></ol></pre>
<p><i id="p_17" class="pid"></i>This outline will need to be updated for our generalized version. You should do this now, in your Reach program (<code>index.rsh</code>).<a href="#p_17" class="pid">17</a></p>
<p><strong>Write down the communication pattern for this program as comments.</strong></p>
<p><i id="p_18" class="pid"></i>Here's what we wrote for our outline:<a href="#p_18" class="pid">18</a></p>
<pre class="snippet numbered"><div class="codeHeader">&nbsp;<a class="far fa-copy copyBtn" data-clipboard-text="// 1. The Funder publishes the ticket price and deadline
// 2. While the deadline has yet to be reached:
//     2a. Allow a Buyer to purchase a ticket
//     2b. Keep track of the winners (last N Buyers)
// 3. Divide the balance evenly amongst the winners.
// 4. Transfer the reward to each winner." href="#"></a></div><ol class="snippet"><li value="1"><span style="color: #6A737D">// 1. The Funder publishes the ticket price and deadline</span></li><li value="2"><span style="color: #6A737D">// 2. While the deadline has yet to be reached:</span></li><li value="3"><span style="color: #6A737D">//     2a. Allow a Buyer to purchase a ticket</span></li><li value="4"><span style="color: #6A737D">//     2b. Keep track of the winners (last N Buyers)</span></li><li value="5"><span style="color: #6A737D">// 3. Divide the balance evenly amongst the winners.</span></li><li value="6"><span style="color: #6A737D">// 4. Transfer the reward to each winner.</span></li></ol></pre>
<p><i id="p_19" class="pid"></i>Now, this outline needs to be converted to a real program.<a href="#p_19" class="pid">19</a></p>
<p><strong>Write down the communication pattern for this program as code.</strong></p>
<p><i id="p_20" class="pid"></i>The body of your application should look something like this:<a href="#p_20" class="pid">20</a></p>
<pre class="snippet numbered"><div class="codeHeader">&nbsp;<a class="far fa-copy copyBtn" data-clipboard-text="// 1. The Funder publishes the ticket price and deadline
Funder.publish(ticketPrice, deadline);

const initialWinners = Array.replicate(NUM_OF_WINNERS, Funder);

const [ keepGoing, winners, ticketsSold ] =
  // 2. While the deadline has yet to be reached:
  parallelReduce([ true, initialWinners, 0 ])
    .invariant(balance() == ticketsSold * ticketPrice)
    .while(keepGoing)
    .case(
      Buyer,
      // 2a. Allow a Buyer to purchase a ticket
      (() => ({
        when: declassify(interact.shouldBuyTicket(ticketPrice)) })),
      (() => ticketPrice),
      () => {
        const buyer = this;
        // 2b. Keep track of the winners (last N Buyers)
        const idx = ticketsSold % NUM_OF_WINNERS;
        const newWinners =
          Array.set(winners, idx, buyer);
        return [ true, newWinners, ticketsSold + 1 ]; })
    .timeout(deadline, () => {
      race(Buyer, Funder).publish();
      return [ false, winners, ticketsSold ]; });

// 3. Divide the balance evenly amongst the winners.
transfer(balance() % NUM_OF_WINNERS).to(Funder);
const reward = balance() / NUM_OF_WINNERS;

// 4. Transfer the reward to each winner.
winners.forEach(winner =>
  transfer(reward).to(winner));

commit();" href="#"></a></div><ol class="snippet"><li value="1"><span style="color: #6A737D">// 1. The Funder publishes the ticket price and deadline</span></li><li value="2"><span style="color: #24292E">Funder.</span><span style="color: #6F42C1">publish</span><span style="color: #24292E">(ticketPrice, deadline);</span></li><li value="3"></li><li value="4"><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">initialWinners</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">Array</span><span style="color: #24292E">.</span><span style="color: #6F42C1">replicate</span><span style="color: #24292E">(</span><span style="color: #005CC5">NUM_OF_WINNERS</span><span style="color: #24292E">, Funder);</span></li><li value="5"></li><li value="6"><span style="color: #D73A49">const</span><span style="color: #24292E"> [ </span><span style="color: #005CC5">keepGoing</span><span style="color: #24292E">, </span><span style="color: #005CC5">winners</span><span style="color: #24292E">, </span><span style="color: #005CC5">ticketsSold</span><span style="color: #24292E"> ] </span><span style="color: #D73A49">=</span></li><li value="7"><span style="color: #24292E">  </span><span style="color: #6A737D">// 2. While the deadline has yet to be reached:</span></li><li value="8"><span style="color: #24292E">  </span><span style="color: #6F42C1">parallelReduce</span><span style="color: #24292E">([ </span><span style="color: #005CC5">true</span><span style="color: #24292E">, initialWinners, </span><span style="color: #005CC5">0</span><span style="color: #24292E"> ])</span></li><li value="9"><span style="color: #24292E">    .</span><span style="color: #6F42C1">invariant</span><span style="color: #24292E">(</span><span style="color: #6F42C1">balance</span><span style="color: #24292E">() </span><span style="color: #D73A49">==</span><span style="color: #24292E"> ticketsSold </span><span style="color: #D73A49">*</span><span style="color: #24292E"> ticketPrice)</span></li><li value="10"><span style="color: #24292E">    .</span><span style="color: #6F42C1">while</span><span style="color: #24292E">(keepGoing)</span></li><li value="11"><span style="color: #24292E">    .</span><span style="color: #6F42C1">case</span><span style="color: #24292E">(</span></li><li value="12"><span style="color: #24292E">      Buyer,</span></li><li value="13"><span style="color: #24292E">      </span><span style="color: #6A737D">// 2a. Allow a Buyer to purchase a ticket</span></li><li value="14"><span style="color: #24292E">      (() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> ({</span></li><li value="15"><span style="color: #24292E">        when: </span><span style="color: #6F42C1">declassify</span><span style="color: #24292E">(interact.</span><span style="color: #6F42C1">shouldBuyTicket</span><span style="color: #24292E">(ticketPrice)) })),</span></li><li value="16"><span style="color: #24292E">      (() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> ticketPrice),</span></li><li value="17"><span style="color: #24292E">      () </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="18"><span style="color: #24292E">        </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">buyer</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">this</span><span style="color: #24292E">;</span></li><li value="19"><span style="color: #24292E">        </span><span style="color: #6A737D">// 2b. Keep track of the winners (last N Buyers)</span></li><li value="20"><span style="color: #24292E">        </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">idx</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> ticketsSold </span><span style="color: #D73A49">%</span><span style="color: #24292E"> </span><span style="color: #005CC5">NUM_OF_WINNERS</span><span style="color: #24292E">;</span></li><li value="21"><span style="color: #24292E">        </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">newWinners</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span></li><li value="22"><span style="color: #24292E">          </span><span style="color: #005CC5">Array</span><span style="color: #24292E">.</span><span style="color: #6F42C1">set</span><span style="color: #24292E">(winners, idx, buyer);</span></li><li value="23"><span style="color: #24292E">        </span><span style="color: #D73A49">return</span><span style="color: #24292E"> [ </span><span style="color: #005CC5">true</span><span style="color: #24292E">, newWinners, ticketsSold </span><span style="color: #D73A49">+</span><span style="color: #24292E"> </span><span style="color: #005CC5">1</span><span style="color: #24292E"> ]; })</span></li><li value="24"><span style="color: #24292E">    .</span><span style="color: #6F42C1">timeout</span><span style="color: #24292E">(deadline, () </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="25"><span style="color: #24292E">      </span><span style="color: #6F42C1">race</span><span style="color: #24292E">(Buyer, Funder).</span><span style="color: #6F42C1">publish</span><span style="color: #24292E">();</span></li><li value="26"><span style="color: #24292E">      </span><span style="color: #D73A49">return</span><span style="color: #24292E"> [ </span><span style="color: #005CC5">false</span><span style="color: #24292E">, winners, ticketsSold ]; });</span></li><li value="27"></li><li value="28"><span style="color: #6A737D">// 3. Divide the balance evenly amongst the winners.</span></li><li value="29"><span style="color: #6F42C1">transfer</span><span style="color: #24292E">(</span><span style="color: #6F42C1">balance</span><span style="color: #24292E">() </span><span style="color: #D73A49">%</span><span style="color: #24292E"> </span><span style="color: #005CC5">NUM_OF_WINNERS</span><span style="color: #24292E">).</span><span style="color: #6F42C1">to</span><span style="color: #24292E">(Funder);</span></li><li value="30"><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">reward</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">balance</span><span style="color: #24292E">() </span><span style="color: #D73A49">/</span><span style="color: #24292E"> </span><span style="color: #005CC5">NUM_OF_WINNERS</span><span style="color: #24292E">;</span></li><li value="31"></li><li value="32"><span style="color: #6A737D">// 4. Transfer the reward to each winner.</span></li><li value="33"><span style="color: #24292E">winners.</span><span style="color: #6F42C1">forEach</span><span style="color: #24292E">(</span><span style="color: #E36209">winner</span><span style="color: #24292E"> </span><span style="color: #D73A49">=&gt;</span></li><li value="34"><span style="color: #24292E">  </span><span style="color: #6F42C1">transfer</span><span style="color: #24292E">(reward).</span><span style="color: #6F42C1">to</span><span style="color: #24292E">(winner));</span></li><li value="35"></li><li value="36"><span style="color: #6F42C1">commit</span><span style="color: #24292E">();</span></li></ol></pre>
<p>
  <i id="p_21" class="pid"></i>Extending this program to track an array of <span class="snip"><span style="color: #24292E">Address</span></span>es, as opposed to a single
  <span class="snip"><span style="color: #24292E">Address</span></span> is fairly straightforward. We maintain an array of size <code>NUM_OF_WINNERS</code>
  and implement a ring buffer to keep it up to date with the most recent <code>N</code> winners, as
  demonstrated in step <code>2b</code>.<a href="#p_21" class="pid">21</a>
</p>
<p>
  <i id="p_22" class="pid"></i>Another aspect of this code worth highlighting is step <code>3</code>.
  We transfer <span class="snip"><span style="color: #6F42C1">balance</span><span style="color: #24292E">() </span><span style="color: #D73A49">%</span><span style="color: #24292E"> </span><span style="color: #005CC5">NUM_OF_WINNERS</span></span> to the winner because the total balance may not be evenly
  divisible by the number of winners.<a href="#p_22" class="pid">22</a>
</p>
<p>
  <i id="p_23" class="pid"></i>For example, if the ticket price is <code>4 ETH</code>
  and there are 10 tickets purchased by Buyers, then the total balance will be <code>40 ETH</code>. However, if the
  application is set to select 3 winners, then 40 cannot be evenly distributed to 3 participants. So, we
  will transfer <code>1 ETH</code> to the Funder, and split the remaining <code>39 ETH</code> between the 3 Buyers.<a href="#p_23" class="pid">23</a>
</p>
<h2 id="workshop-fomo-generalized-ai" class="refHeader">Assertion Insertion<a aria-hidden="true" tabindex="-1" href="#workshop-fomo-generalized-ai"><span class="icon icon-link"></span></a></h2>
<p>
  <i id="p_24" class="pid"></i>This program doesn't have many interesting properties to prove
  as assertions, beyond the token linearity property. The
  only property of interest is the <span class="snip"><span style="color: #24292E">parallelReduce</span></span> invariant
  which states that the balance must be equal to the number of tickets
  sold multiplied by the ticket price.<a href="#p_24" class="pid">24</a>
</p>
<h2 id="workshop-fomo-generalized-ii" class="refHeader">Interaction Introduction<a aria-hidden="true" tabindex="-1" href="#workshop-fomo-generalized-ii"><span class="icon icon-link"></span></a></h2>
<p>
  <i id="p_25" class="pid"></i>Next, we need to insert the appropriate calls to <span class="snip"><span style="color: #24292E">interact</span></span>.
  In this case, our program is very simple and we expect you'll do a great job without further discussion.<a href="#p_25" class="pid">25</a>
</p>
<p><strong>Insert <code>interact</code> calls to the frontend into the program.</strong></p>
<p><i id="p_26" class="pid"></i>Let's look at our whole program now:<a href="#p_26" class="pid">26</a></p>
<pre class="snippet numbered"><div class="codeHeader"><a href="https://github.com/reach-sh/reach-lang/tree/master/examples/workshop-fomo-generalized/index.rsh">/examples/workshop-fomo-generalized/index.rsh</a><a class="far fa-copy copyBtn" data-clipboard-text="'reach 0.1';
'use strict';

// FOMO Workshop generalized to last N winners
const NUM_OF_WINNERS = 3;

const CommonInterface = {
  showOutcome: Fun([Array(Address, NUM_OF_WINNERS)], Null),
};

const FunderInterface = {
  ...CommonInterface,
  getParams: Fun([], Object({
    deadline: UInt, // relative deadline
    ticketPrice: UInt,
  })),
};

const BuyerInterface = {
  ...CommonInterface,
  shouldBuyTicket: Fun([UInt], Bool),
  showPurchase: Fun([Address], Null),
};

export const main = Reach.App(
  { },
  [
    Participant('Funder', FunderInterface), ParticipantClass('Buyer', BuyerInterface),
  ],
  (Funder, Buyer) => {
    const showOutcome = (winners) =>
      each([Funder, Buyer], () => interact.showOutcome(winners));

    Funder.only(() => {
      const { ticketPrice, deadline } = declassify(interact.getParams()); });
    Funder.publish(ticketPrice, deadline);

    const initialWinners = Array.replicate(NUM_OF_WINNERS, Funder);

    // Until deadline, allow buyers to buy ticket
    const [ keepGoing, winners, ticketsSold ] =
      parallelReduce([ true, initialWinners, 0 ])
        .invariant(balance() == ticketsSold * ticketPrice)
        .while(keepGoing)
        .case(
          Buyer,
          () => ({
            when: declassify(interact.shouldBuyTicket(ticketPrice)) }),
          (_) => ticketPrice,
          (_) => {
            const buyer = this;
            Buyer.only(() => interact.showPurchase(buyer));
            const idx = ticketsSold % NUM_OF_WINNERS;
            const newWinners =
              Array.set(winners, idx, buyer);
            return [ true, newWinners, ticketsSold + 1 ]; })
        .timeout(relativeTime(deadline), () => {
          Anybody.publish();
          return [ false, winners, ticketsSold ]; });

    transfer(balance() % NUM_OF_WINNERS).to(Funder);
    const reward = balance() / NUM_OF_WINNERS;

    winners.forEach(winner =>
      transfer(reward).to(winner));

    commit();
    showOutcome(winners);
  });" href="#"></a></div><ol class="snippet"><li value="1"><span style="color: #032F62">'reach 0.1'</span><span style="color: #24292E">;</span></li><li value="2"><span style="color: #032F62">'use strict'</span><span style="color: #24292E">;</span></li><li value="3"></li><li value="4"><span style="color: #6A737D">// FOMO Workshop generalized to last N winners</span></li><li value="5"><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">NUM_OF_WINNERS</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">3</span><span style="color: #24292E">;</span></li><li value="6"></li><li value="7"><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">CommonInterface</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> {</span></li><li value="8"><span style="color: #24292E">  showOutcome: </span><span style="color: #6F42C1">Fun</span><span style="color: #24292E">([</span><span style="color: #005CC5">Array</span><span style="color: #24292E">(Address, </span><span style="color: #005CC5">NUM_OF_WINNERS</span><span style="color: #24292E">)], Null),</span></li><li value="9"><span style="color: #24292E">};</span></li><li value="10"></li><li value="11"><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">FunderInterface</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> {</span></li><li value="12"><span style="color: #24292E">  </span><span style="color: #D73A49">...</span><span style="color: #24292E">CommonInterface,</span></li><li value="13"><span style="color: #24292E">  getParams: </span><span style="color: #6F42C1">Fun</span><span style="color: #24292E">([], </span><span style="color: #005CC5">Object</span><span style="color: #24292E">({</span></li><li value="14"><span style="color: #24292E">    deadline: UInt, </span><span style="color: #6A737D">// relative deadline</span></li><li value="15"><span style="color: #24292E">    ticketPrice: UInt,</span></li><li value="16"><span style="color: #24292E">  })),</span></li><li value="17"><span style="color: #24292E">};</span></li><li value="18"></li><li value="19"><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">BuyerInterface</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> {</span></li><li value="20"><span style="color: #24292E">  </span><span style="color: #D73A49">...</span><span style="color: #24292E">CommonInterface,</span></li><li value="21"><span style="color: #24292E">  shouldBuyTicket: </span><span style="color: #6F42C1">Fun</span><span style="color: #24292E">([UInt], Bool),</span></li><li value="22"><span style="color: #24292E">  showPurchase: </span><span style="color: #6F42C1">Fun</span><span style="color: #24292E">([Address], Null),</span></li><li value="23"><span style="color: #24292E">};</span></li><li value="24"></li><li value="25"><span style="color: #D73A49">export</span><span style="color: #24292E"> </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">main</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> Reach.</span><span style="color: #6F42C1">App</span><span style="color: #24292E">(</span></li><li value="26"><span style="color: #24292E">  { },</span></li><li value="27"><span style="color: #24292E">  [</span></li><li value="28"><span style="color: #24292E">    </span><span style="color: #6F42C1">Participant</span><span style="color: #24292E">(</span><span style="color: #032F62">'Funder'</span><span style="color: #24292E">, FunderInterface), </span><span style="color: #6F42C1">ParticipantClass</span><span style="color: #24292E">(</span><span style="color: #032F62">'Buyer'</span><span style="color: #24292E">, BuyerInterface),</span></li><li value="29"><span style="color: #24292E">  ],</span></li><li value="30"><span style="color: #24292E">  (</span><span style="color: #E36209">Funder</span><span style="color: #24292E">, </span><span style="color: #E36209">Buyer</span><span style="color: #24292E">) </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="31"><span style="color: #24292E">    </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #6F42C1">showOutcome</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> (</span><span style="color: #E36209">winners</span><span style="color: #24292E">) </span><span style="color: #D73A49">=&gt;</span></li><li value="32"><span style="color: #24292E">      </span><span style="color: #6F42C1">each</span><span style="color: #24292E">([Funder, Buyer], () </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> interact.</span><span style="color: #6F42C1">showOutcome</span><span style="color: #24292E">(winners));</span></li><li value="33"></li><li value="34"><span style="color: #24292E">    Funder.</span><span style="color: #6F42C1">only</span><span style="color: #24292E">(() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="35"><span style="color: #24292E">      </span><span style="color: #D73A49">const</span><span style="color: #24292E"> { </span><span style="color: #005CC5">ticketPrice</span><span style="color: #24292E">, </span><span style="color: #005CC5">deadline</span><span style="color: #24292E"> } </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">declassify</span><span style="color: #24292E">(interact.</span><span style="color: #6F42C1">getParams</span><span style="color: #24292E">()); });</span></li><li value="36"><span style="color: #24292E">    Funder.</span><span style="color: #6F42C1">publish</span><span style="color: #24292E">(ticketPrice, deadline);</span></li><li value="37"></li><li value="38"><span style="color: #24292E">    </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">initialWinners</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">Array</span><span style="color: #24292E">.</span><span style="color: #6F42C1">replicate</span><span style="color: #24292E">(</span><span style="color: #005CC5">NUM_OF_WINNERS</span><span style="color: #24292E">, Funder);</span></li><li value="39"></li><li value="40"><span style="color: #24292E">    </span><span style="color: #6A737D">// Until deadline, allow buyers to buy ticket</span></li><li value="41"><span style="color: #24292E">    </span><span style="color: #D73A49">const</span><span style="color: #24292E"> [ </span><span style="color: #005CC5">keepGoing</span><span style="color: #24292E">, </span><span style="color: #005CC5">winners</span><span style="color: #24292E">, </span><span style="color: #005CC5">ticketsSold</span><span style="color: #24292E"> ] </span><span style="color: #D73A49">=</span></li><li value="42"><span style="color: #24292E">      </span><span style="color: #6F42C1">parallelReduce</span><span style="color: #24292E">([ </span><span style="color: #005CC5">true</span><span style="color: #24292E">, initialWinners, </span><span style="color: #005CC5">0</span><span style="color: #24292E"> ])</span></li><li value="43"><span style="color: #24292E">        .</span><span style="color: #6F42C1">invariant</span><span style="color: #24292E">(</span><span style="color: #6F42C1">balance</span><span style="color: #24292E">() </span><span style="color: #D73A49">==</span><span style="color: #24292E"> ticketsSold </span><span style="color: #D73A49">*</span><span style="color: #24292E"> ticketPrice)</span></li><li value="44"><span style="color: #24292E">        .</span><span style="color: #6F42C1">while</span><span style="color: #24292E">(keepGoing)</span></li><li value="45"><span style="color: #24292E">        .</span><span style="color: #6F42C1">case</span><span style="color: #24292E">(</span></li><li value="46"><span style="color: #24292E">          Buyer,</span></li><li value="47"><span style="color: #24292E">          () </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> ({</span></li><li value="48"><span style="color: #24292E">            when: </span><span style="color: #6F42C1">declassify</span><span style="color: #24292E">(interact.</span><span style="color: #6F42C1">shouldBuyTicket</span><span style="color: #24292E">(ticketPrice)) }),</span></li><li value="49"><span style="color: #24292E">          (</span><span style="color: #E36209">_</span><span style="color: #24292E">) </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> ticketPrice,</span></li><li value="50"><span style="color: #24292E">          (</span><span style="color: #E36209">_</span><span style="color: #24292E">) </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="51"><span style="color: #24292E">            </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">buyer</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">this</span><span style="color: #24292E">;</span></li><li value="52"><span style="color: #24292E">            Buyer.</span><span style="color: #6F42C1">only</span><span style="color: #24292E">(() </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> interact.</span><span style="color: #6F42C1">showPurchase</span><span style="color: #24292E">(buyer));</span></li><li value="53"><span style="color: #24292E">            </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">idx</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> ticketsSold </span><span style="color: #D73A49">%</span><span style="color: #24292E"> </span><span style="color: #005CC5">NUM_OF_WINNERS</span><span style="color: #24292E">;</span></li><li value="54"><span style="color: #24292E">            </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">newWinners</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span></li><li value="55"><span style="color: #24292E">              </span><span style="color: #005CC5">Array</span><span style="color: #24292E">.</span><span style="color: #6F42C1">set</span><span style="color: #24292E">(winners, idx, buyer);</span></li><li value="56"><span style="color: #24292E">            </span><span style="color: #D73A49">return</span><span style="color: #24292E"> [ </span><span style="color: #005CC5">true</span><span style="color: #24292E">, newWinners, ticketsSold </span><span style="color: #D73A49">+</span><span style="color: #24292E"> </span><span style="color: #005CC5">1</span><span style="color: #24292E"> ]; })</span></li><li value="57"><span style="color: #24292E">        .</span><span style="color: #6F42C1">timeout</span><span style="color: #24292E">(</span><span style="color: #6F42C1">relativeTime</span><span style="color: #24292E">(deadline), () </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="58"><span style="color: #24292E">          Anybody.</span><span style="color: #6F42C1">publish</span><span style="color: #24292E">();</span></li><li value="59"><span style="color: #24292E">          </span><span style="color: #D73A49">return</span><span style="color: #24292E"> [ </span><span style="color: #005CC5">false</span><span style="color: #24292E">, winners, ticketsSold ]; });</span></li><li value="60"></li><li value="61"><span style="color: #24292E">    </span><span style="color: #6F42C1">transfer</span><span style="color: #24292E">(</span><span style="color: #6F42C1">balance</span><span style="color: #24292E">() </span><span style="color: #D73A49">%</span><span style="color: #24292E"> </span><span style="color: #005CC5">NUM_OF_WINNERS</span><span style="color: #24292E">).</span><span style="color: #6F42C1">to</span><span style="color: #24292E">(Funder);</span></li><li value="62"><span style="color: #24292E">    </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">reward</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">balance</span><span style="color: #24292E">() </span><span style="color: #D73A49">/</span><span style="color: #24292E"> </span><span style="color: #005CC5">NUM_OF_WINNERS</span><span style="color: #24292E">;</span></li><li value="63"></li><li value="64"><span style="color: #24292E">    winners.</span><span style="color: #6F42C1">forEach</span><span style="color: #24292E">(</span><span style="color: #E36209">winner</span><span style="color: #24292E"> </span><span style="color: #D73A49">=&gt;</span></li><li value="65"><span style="color: #24292E">      </span><span style="color: #6F42C1">transfer</span><span style="color: #24292E">(reward).</span><span style="color: #6F42C1">to</span><span style="color: #24292E">(winner));</span></li><li value="66"></li><li value="67"><span style="color: #24292E">    </span><span style="color: #6F42C1">commit</span><span style="color: #24292E">();</span></li><li value="68"><span style="color: #24292E">    </span><span style="color: #6F42C1">showOutcome</span><span style="color: #24292E">(winners);</span></li><li value="69"><span style="color: #24292E">  });</span></li></ol></pre>
<h2 id="workshop-fomo-generalized-de" class="refHeader">Deployment Decisions<a aria-hidden="true" tabindex="-1" href="#workshop-fomo-generalized-de"><span class="icon icon-link"></span></a></h2>
<p>
  <i id="p_27" class="pid"></i>Next, it is time to test our program. As usual, we'll present a completely
  automated test deployment, rather than an interactive one.<a href="#p_27" class="pid">27</a>
</p>
<p>
  <i id="p_28" class="pid"></i>The program is fairly straightfoward to test. We just create test accounts for
  the Funder and any number of Buyers. The decision to purchase a ticket by
  a Buyer will rely simply on generating a random boolean.<a href="#p_28" class="pid">28</a>
</p>
<p><strong>Decide how you will deploy and use this application.</strong></p>
<p><i id="p_29" class="pid"></i>Here's the JavaScript frontend we wrote:<a href="#p_29" class="pid">29</a></p>
<pre class="snippet numbered"><div class="codeHeader"><a href="https://github.com/reach-sh/reach-lang/tree/master/examples/workshop-fomo-generalized/index.mjs">/examples/workshop-fomo-generalized/index.mjs</a><a class="far fa-copy copyBtn" data-clipboard-text="import {loadStdlib, getConnector} from '@reach-sh/stdlib';
import * as backend from './build/index.main.mjs';

const numOfBuyers = 10;

(async () => {
  const stdlib = await loadStdlib();
  const connector = getConnector();
  const startingBalance = stdlib.parseCurrency(100);

  const accFunder = await stdlib.newTestAccount(startingBalance);
  const accBuyerArray = await Promise.all(
    Array.from({ length: numOfBuyers }, () =>
      stdlib.newTestAccount(startingBalance)
    )
  );

  const ctcFunder = accFunder.deploy(backend);
  const ctcInfo   = ctcFunder.getInfo();

  const funderParams = {
    ticketPrice: stdlib.parseCurrency(3),
    deadline: connector === 'ALGO' ? 4 : 8,
  };

  const resultText = (outcome, addr) =>
    outcome.includes(addr) ? 'won' : 'lost';

  const bidHistory = {};

  await Promise.all([
    backend.Funder(ctcFunder, {
      showOutcome: (outcome) =>
        console.log(`Funder saw they ${resultText(outcome, accFunder.getAddress())}`),
      getParams: () => funderParams,
    }),
  ].concat(
    accBuyerArray.map((accBuyer, i) => {
      const ctcBuyer = accBuyer.attach(backend, ctcInfo);
      const Who = `Buyer #${i}`;
      return backend.Buyer(ctcBuyer, {
        showOutcome: (outcome) =>
          console.log(`${Who} saw they ${resultText(outcome, accBuyer.getAddress())}`),
        shouldBuyTicket : () =>
          !bidHistory[Who] &amp;&amp; Math.random() < 0.5,
        showPurchase: (addr) => {
          if (stdlib.addressEq(addr, accBuyer)) {
            console.log(`${Who} bought a ticket.`);
            bidHistory[Who] = true;
          }
        }
      });
    })
  ));
})();" href="#"></a></div><ol class="snippet"><li value="1"><span style="color: #D73A49">import</span><span style="color: #24292E"> {loadStdlib, getConnector} </span><span style="color: #D73A49">from</span><span style="color: #24292E"> </span><span style="color: #032F62">'@reach-sh/stdlib'</span><span style="color: #24292E">;</span></li><li value="2"><span style="color: #D73A49">import</span><span style="color: #24292E"> </span><span style="color: #005CC5">*</span><span style="color: #24292E"> </span><span style="color: #D73A49">as</span><span style="color: #24292E"> backend </span><span style="color: #D73A49">from</span><span style="color: #24292E"> </span><span style="color: #032F62">'./build/index.main.mjs'</span><span style="color: #24292E">;</span></li><li value="3"></li><li value="4"><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">numOfBuyers</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">10</span><span style="color: #24292E">;</span></li><li value="5"></li><li value="6"><span style="color: #24292E">(</span><span style="color: #D73A49">async</span><span style="color: #24292E"> () </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="7"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">stdlib</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">await</span><span style="color: #24292E"> </span><span style="color: #6F42C1">loadStdlib</span><span style="color: #24292E">();</span></li><li value="8"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">connector</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #6F42C1">getConnector</span><span style="color: #24292E">();</span></li><li value="9"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">startingBalance</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> stdlib.</span><span style="color: #6F42C1">parseCurrency</span><span style="color: #24292E">(</span><span style="color: #005CC5">100</span><span style="color: #24292E">);</span></li><li value="10"></li><li value="11"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">accFunder</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">await</span><span style="color: #24292E"> stdlib.</span><span style="color: #6F42C1">newTestAccount</span><span style="color: #24292E">(startingBalance);</span></li><li value="12"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">accBuyerArray</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #D73A49">await</span><span style="color: #24292E"> </span><span style="color: #005CC5">Promise</span><span style="color: #24292E">.</span><span style="color: #6F42C1">all</span><span style="color: #24292E">(</span></li><li value="13"><span style="color: #24292E">    </span><span style="color: #005CC5">Array</span><span style="color: #24292E">.</span><span style="color: #6F42C1">from</span><span style="color: #24292E">({ length: numOfBuyers }, () </span><span style="color: #D73A49">=&gt;</span></li><li value="14"><span style="color: #24292E">      stdlib.</span><span style="color: #6F42C1">newTestAccount</span><span style="color: #24292E">(startingBalance)</span></li><li value="15"><span style="color: #24292E">    )</span></li><li value="16"><span style="color: #24292E">  );</span></li><li value="17"></li><li value="18"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">ctcFunder</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> accFunder.</span><span style="color: #6F42C1">deploy</span><span style="color: #24292E">(backend);</span></li><li value="19"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">ctcInfo</span><span style="color: #24292E">   </span><span style="color: #D73A49">=</span><span style="color: #24292E"> ctcFunder.</span><span style="color: #6F42C1">getInfo</span><span style="color: #24292E">();</span></li><li value="20"></li><li value="21"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">funderParams</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> {</span></li><li value="22"><span style="color: #24292E">    ticketPrice: stdlib.</span><span style="color: #6F42C1">parseCurrency</span><span style="color: #24292E">(</span><span style="color: #005CC5">3</span><span style="color: #24292E">),</span></li><li value="23"><span style="color: #24292E">    deadline: connector </span><span style="color: #D73A49">===</span><span style="color: #24292E"> </span><span style="color: #032F62">'ALGO'</span><span style="color: #24292E"> </span><span style="color: #D73A49">?</span><span style="color: #24292E"> </span><span style="color: #005CC5">4</span><span style="color: #24292E"> </span><span style="color: #D73A49">:</span><span style="color: #24292E"> </span><span style="color: #005CC5">8</span><span style="color: #24292E">,</span></li><li value="24"><span style="color: #24292E">  };</span></li><li value="25"></li><li value="26"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #6F42C1">resultText</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> (</span><span style="color: #E36209">outcome</span><span style="color: #24292E">, </span><span style="color: #E36209">addr</span><span style="color: #24292E">) </span><span style="color: #D73A49">=&gt;</span></li><li value="27"><span style="color: #24292E">    outcome.</span><span style="color: #6F42C1">includes</span><span style="color: #24292E">(addr) </span><span style="color: #D73A49">?</span><span style="color: #24292E"> </span><span style="color: #032F62">'won'</span><span style="color: #24292E"> </span><span style="color: #D73A49">:</span><span style="color: #24292E"> </span><span style="color: #032F62">'lost'</span><span style="color: #24292E">;</span></li><li value="28"></li><li value="29"><span style="color: #24292E">  </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">bidHistory</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> {};</span></li><li value="30"></li><li value="31"><span style="color: #24292E">  </span><span style="color: #D73A49">await</span><span style="color: #24292E"> </span><span style="color: #005CC5">Promise</span><span style="color: #24292E">.</span><span style="color: #6F42C1">all</span><span style="color: #24292E">([</span></li><li value="32"><span style="color: #24292E">    backend.</span><span style="color: #6F42C1">Funder</span><span style="color: #24292E">(ctcFunder, {</span></li><li value="33"><span style="color: #24292E">      </span><span style="color: #6F42C1">showOutcome</span><span style="color: #24292E">: (</span><span style="color: #E36209">outcome</span><span style="color: #24292E">) </span><span style="color: #D73A49">=&gt;</span></li><li value="34"><span style="color: #24292E">        console.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(</span><span style="color: #032F62">`Funder saw they ${</span><span style="color: #6F42C1">resultText</span><span style="color: #032F62">(</span><span style="color: #24292E">outcome</span><span style="color: #032F62">, </span><span style="color: #24292E">accFunder</span><span style="color: #032F62">.</span><span style="color: #6F42C1">getAddress</span><span style="color: #032F62">())</span><span style="color: #032F62">}`</span><span style="color: #24292E">),</span></li><li value="35"><span style="color: #24292E">      </span><span style="color: #6F42C1">getParams</span><span style="color: #24292E">: () </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> funderParams,</span></li><li value="36"><span style="color: #24292E">    }),</span></li><li value="37"><span style="color: #24292E">  ].</span><span style="color: #6F42C1">concat</span><span style="color: #24292E">(</span></li><li value="38"><span style="color: #24292E">    accBuyerArray.</span><span style="color: #6F42C1">map</span><span style="color: #24292E">((</span><span style="color: #E36209">accBuyer</span><span style="color: #24292E">, </span><span style="color: #E36209">i</span><span style="color: #24292E">) </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="39"><span style="color: #24292E">      </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">ctcBuyer</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> accBuyer.</span><span style="color: #6F42C1">attach</span><span style="color: #24292E">(backend, ctcInfo);</span></li><li value="40"><span style="color: #24292E">      </span><span style="color: #D73A49">const</span><span style="color: #24292E"> </span><span style="color: #005CC5">Who</span><span style="color: #24292E"> </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #032F62">`Buyer #${</span><span style="color: #24292E">i</span><span style="color: #032F62">}`</span><span style="color: #24292E">;</span></li><li value="41"><span style="color: #24292E">      </span><span style="color: #D73A49">return</span><span style="color: #24292E"> backend.</span><span style="color: #6F42C1">Buyer</span><span style="color: #24292E">(ctcBuyer, {</span></li><li value="42"><span style="color: #24292E">        </span><span style="color: #6F42C1">showOutcome</span><span style="color: #24292E">: (</span><span style="color: #E36209">outcome</span><span style="color: #24292E">) </span><span style="color: #D73A49">=&gt;</span></li><li value="43"><span style="color: #24292E">          console.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(</span><span style="color: #032F62">`${</span><span style="color: #24292E">Who</span><span style="color: #032F62">} saw they ${</span><span style="color: #6F42C1">resultText</span><span style="color: #032F62">(</span><span style="color: #24292E">outcome</span><span style="color: #032F62">, </span><span style="color: #24292E">accBuyer</span><span style="color: #032F62">.</span><span style="color: #6F42C1">getAddress</span><span style="color: #032F62">())</span><span style="color: #032F62">}`</span><span style="color: #24292E">),</span></li><li value="44"><span style="color: #24292E">        </span><span style="color: #6F42C1">shouldBuyTicket</span><span style="color: #24292E"> : () </span><span style="color: #D73A49">=&gt;</span></li><li value="45"><span style="color: #24292E">          </span><span style="color: #D73A49">!</span><span style="color: #24292E">bidHistory[Who] </span><span style="color: #D73A49">&amp;&amp;</span><span style="color: #24292E"> </span><span style="color: #005CC5">Math</span><span style="color: #24292E">.</span><span style="color: #005CC5">random</span><span style="color: #24292E">() </span><span style="color: #D73A49">&lt;</span><span style="color: #24292E"> </span><span style="color: #005CC5">0.5</span><span style="color: #24292E">,</span></li><li value="46"><span style="color: #24292E">        </span><span style="color: #6F42C1">showPurchase</span><span style="color: #24292E">: (</span><span style="color: #E36209">addr</span><span style="color: #24292E">) </span><span style="color: #D73A49">=&gt;</span><span style="color: #24292E"> {</span></li><li value="47"><span style="color: #24292E">          </span><span style="color: #D73A49">if</span><span style="color: #24292E"> (stdlib.</span><span style="color: #6F42C1">addressEq</span><span style="color: #24292E">(addr, accBuyer)) {</span></li><li value="48"><span style="color: #24292E">            console.</span><span style="color: #6F42C1">log</span><span style="color: #24292E">(</span><span style="color: #032F62">`${</span><span style="color: #24292E">Who</span><span style="color: #032F62">} bought a ticket.`</span><span style="color: #24292E">);</span></li><li value="49"><span style="color: #24292E">            bidHistory[Who] </span><span style="color: #D73A49">=</span><span style="color: #24292E"> </span><span style="color: #005CC5">true</span><span style="color: #24292E">;</span></li><li value="50"><span style="color: #24292E">          }</span></li><li value="51"><span style="color: #24292E">        }</span></li><li value="52"><span style="color: #24292E">      });</span></li><li value="53"><span style="color: #24292E">    })</span></li><li value="54"><span style="color: #24292E">  ));</span></li><li value="55"><span style="color: #24292E">})();</span></li></ol></pre>
<p><i id="p_30" class="pid"></i>Let's see what it looks like when we run the program:<a href="#p_30" class="pid">30</a></p>
<pre class="snippet numbered"><div class="codeHeader">&nbsp;<a class="far fa-copy copyBtn" data-clipboard-text="$ ../reach run
Buyer #6 bought a ticket.
Buyer #3 bought a ticket.
...
Buyer #4 bought a ticket.
Buyer #1 bought a ticket.
Buyer #3 bought a ticket.
Buyer #8 bought a ticket.
Buyer #6 bought a ticket.
Funder saw they lost
Buyer #1 saw they lost
Buyer #5 saw they lost
Buyer #9 saw they lost
Buyer #0 saw they lost
Buyer #8 saw they won
Buyer #7 saw they lost
Buyer #2 saw they lost
Buyer #6 saw they won
Buyer #3 saw they won
Buyer #4 saw they lost" href="#"></a></div><ol class="snippet"><li value="1">$ ../reach run</li><li value="2">Buyer #6 bought a ticket.</li><li value="3">Buyer #3 bought a ticket.</li><li value="4">...</li><li value="5">Buyer #4 bought a ticket.</li><li value="6">Buyer #1 bought a ticket.</li><li value="7">Buyer #3 bought a ticket.</li><li value="8">Buyer #8 bought a ticket.</li><li value="9">Buyer #6 bought a ticket.</li><li value="10">Funder saw they lost</li><li value="11">Buyer #1 saw they lost</li><li value="12">Buyer #5 saw they lost</li><li value="13">Buyer #9 saw they lost</li><li value="14">Buyer #0 saw they lost</li><li value="15">Buyer #8 saw they won</li><li value="16">Buyer #7 saw they lost</li><li value="17">Buyer #2 saw they lost</li><li value="18">Buyer #6 saw they won</li><li value="19">Buyer #3 saw they won</li><li value="20">Buyer #4 saw they lost</li></ol></pre>
<h2 id="workshop-fomo-generalized-dns" class="refHeader">Discussion and Next Steps<a aria-hidden="true" tabindex="-1" href="#workshop-fomo-generalized-dns"><span class="icon icon-link"></span></a></h2>
<p><i id="p_31" class="pid"></i>Great job!<a href="#p_31" class="pid">31</a></p>
<p>
  <i id="p_32" class="pid"></i>You've now implemented a generalized Fear of Missing Out game. You can try extending
  this application with additional features such as:<a href="#p_32" class="pid">32</a>
</p>
<ul>
  <li><i id="p_33" class="pid"></i>Slightly increasing the ticket price with each purchase.<a href="#p_33" class="pid">33</a></li>
  <li>
    <i id="p_34" class="pid"></i>Introducing a small payout system (dividends) to Buyers as the game progresses.
    e.g. every time the ring buffer is filled.<a href="#p_34" class="pid">34</a>
  </li>
</ul>
<p><i id="p_35" class="pid"></i>If you found this workshop rewarding, please let us know on <a href="https://discord.gg/AZsgcXu">the Discord community</a>!<a href="#p_35" class="pid">35</a></p>