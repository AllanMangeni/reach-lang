<p>
  The <a href="/md/rpc/proto/#ref-backends-rpc-proto">Reach RPC Protocol</a> is designed to be simple to implement in languages that support HTTP and JSON interaction.
  This document walks through the implementation of an RPC client in <a href="https://www.python.org">Python</a>.
  An example use of this library is shown in the <a href="/md/tut/rps/7-rpc/#tut-7-rpc">tutorial section on RPC-based frontends</a>.
  The entire library is 80 lines of code.
</p>
<p>
  The library uses a few standard Python libraries for interacting with JSON,
  HTTP servers, and networking:
</p>
<pre class="snippet numbered"><ol class="snippet"><li value="1"><span style="color: #6E7781"># flake8: noqa</span></li><li value="2"></li><li value="3"><span style="color: #CF222E">import</span><span style="color: #24292F"> json</span></li><li value="4"><span style="color: #CF222E">import</span><span style="color: #24292F"> os</span></li><li value="5"><span style="color: #CF222E">import</span><span style="color: #24292F"> requests</span></li><li value="6"><span style="color: #CF222E">import</span><span style="color: #24292F"> socket</span></li><li value="7"><span style="color: #CF222E">import</span><span style="color: #24292F"> time</span></li><li value="8"><span style="color: #CF222E">import</span><span style="color: #24292F"> urllib3</span></li><li value="9"></li></ol></pre>
<pre class="snippet numbered"><ol class="snippet"><li value="11"><span style="color: #CF222E">def</span><span style="color: #24292F"> </span><span style="color: #8250DF">mk_rpc</span><span style="color: #24292F">(opts</span><span style="color: #CF222E">=</span><span style="color: #24292F">{}):</span></li><li value="12"><span style="color: #24292F">    </span><span style="color: #CF222E">def</span><span style="color: #24292F"> </span><span style="color: #8250DF">opt_of</span><span style="color: #24292F">(field, envvar, default</span><span style="color: #CF222E">=</span><span style="color: #0550AE">None</span><span style="color: #24292F">, f</span><span style="color: #CF222E">=lambda</span><span style="color: #24292F"> x: x):</span></li><li value="13"><span style="color: #24292F">        opt </span><span style="color: #CF222E">=</span><span style="color: #24292F">  f(opts.get(field))        </span><span style="color: #CF222E">if</span><span style="color: #24292F"> opts.get(field)        </span><span style="color: #CF222E">is</span><span style="color: #24292F"> </span><span style="color: #CF222E">not</span><span style="color: #24292F"> </span><span style="color: #0550AE">None</span><span style="color: #24292F"> \</span></li><li value="14"><span style="color: #24292F">          </span><span style="color: #CF222E">else</span><span style="color: #24292F"> f(os.environ.get(envvar)) </span><span style="color: #CF222E">if</span><span style="color: #24292F"> os.environ.get(envvar) </span><span style="color: #CF222E">is</span><span style="color: #24292F"> </span><span style="color: #CF222E">not</span><span style="color: #24292F"> </span><span style="color: #0550AE">None</span><span style="color: #24292F"> \</span></li><li value="15"><span style="color: #24292F">          </span><span style="color: #CF222E">else</span><span style="color: #24292F"> default</span></li><li value="16"></li><li value="17"><span style="color: #24292F">        </span><span style="color: #CF222E">if</span><span style="color: #24292F"> opt </span><span style="color: #CF222E">is</span><span style="color: #24292F"> </span><span style="color: #0550AE">None</span><span style="color: #24292F">:</span></li><li value="18"><span style="color: #24292F">            </span><span style="color: #CF222E">raise</span><span style="color: #24292F"> </span><span style="color: #0550AE">RuntimeError</span><span style="color: #24292F">(</span><span style="color: #0A3069">'Mandatory configuration unset for: </span><span style="color: #0550AE">%s</span><span style="color: #0A3069">'</span><span style="color: #24292F"> </span><span style="color: #CF222E">%</span><span style="color: #24292F"> field)</span></li><li value="19"></li><li value="20"><span style="color: #24292F">        </span><span style="color: #CF222E">return</span><span style="color: #24292F"> opt</span></li><li value="21"></li><li value="22"><span style="color: #24292F">    host    </span><span style="color: #CF222E">=</span><span style="color: #24292F"> opt_of(</span><span style="color: #0A3069">'host'</span><span style="color: #24292F">,    </span><span style="color: #0A3069">'REACH_RPC_SERVER'</span><span style="color: #24292F">)</span></li><li value="23"><span style="color: #24292F">    port    </span><span style="color: #CF222E">=</span><span style="color: #24292F"> opt_of(</span><span style="color: #0A3069">'port'</span><span style="color: #24292F">,    </span><span style="color: #0A3069">'REACH_RPC_PORT'</span><span style="color: #24292F">)</span></li><li value="24"><span style="color: #24292F">    key     </span><span style="color: #CF222E">=</span><span style="color: #24292F"> opt_of(</span><span style="color: #0A3069">'key'</span><span style="color: #24292F">,     </span><span style="color: #0A3069">'REACH_RPC_KEY'</span><span style="color: #24292F">)</span></li><li value="25"><span style="color: #24292F">    timeout </span><span style="color: #CF222E">=</span><span style="color: #24292F"> opt_of(</span><span style="color: #0A3069">'timeout'</span><span style="color: #24292F">, </span><span style="color: #0A3069">'REACH_RPC_TIMEOUT'</span><span style="color: #24292F">,               </span><span style="color: #953800">f</span><span style="color: #CF222E">=</span><span style="color: #0550AE">int</span><span style="color: #24292F">, </span><span style="color: #953800">default</span><span style="color: #CF222E">=</span><span style="color: #0550AE">5</span><span style="color: #24292F">)</span></li><li value="26"><span style="color: #24292F">    verify  </span><span style="color: #CF222E">=</span><span style="color: #24292F"> opt_of(</span><span style="color: #0A3069">'verify'</span><span style="color: #24292F">,  </span><span style="color: #0A3069">'REACH_RPC_TLS_REJECT_UNVERIFIED'</span><span style="color: #24292F">, </span><span style="color: #953800">f</span><span style="color: #CF222E">=lambda</span><span style="color: #24292F"> x: x </span><span style="color: #CF222E">!=</span><span style="color: #24292F"> </span><span style="color: #0A3069">'0'</span><span style="color: #24292F">)</span></li><li value="27"></li></ol></pre>
<p>The library provides a single function, <code>mk_rpc</code>, that accepts the <a href="/md/rpc/#ref-backends-rpc-opts">Reach RPC Client Standard Options</a>.</p>
<pre class="snippet numbered"><ol class="snippet"><li value="28"><span style="color: #24292F">    </span><span style="color: #CF222E">if</span><span style="color: #24292F"> </span><span style="color: #CF222E">not</span><span style="color: #24292F"> verify:</span></li><li value="29"><span style="color: #24292F">        urllib3.disable_warnings()</span></li><li value="30"><span style="color: #24292F">        </span><span style="color: #0550AE">print</span><span style="color: #24292F">(</span><span style="color: #0A3069">'</span><span style="color: #0550AE">\n</span><span style="color: #0A3069">*** Warning! TLS verification disabled! ***</span><span style="color: #0550AE">\n</span><span style="color: #0A3069">'</span><span style="color: #24292F">)</span></li><li value="31"><span style="color: #24292F">        </span><span style="color: #0550AE">print</span><span style="color: #24292F">(</span><span style="color: #0A3069">' This is highly insecure in Real Lifeâ„¢ applications and must'</span><span style="color: #24292F">)</span></li><li value="32"><span style="color: #24292F">        </span><span style="color: #0550AE">print</span><span style="color: #24292F">(</span><span style="color: #0A3069">' only be permitted under controlled conditions (such as'</span><span style="color: #24292F">)</span></li><li value="33"><span style="color: #24292F">        </span><span style="color: #0550AE">print</span><span style="color: #24292F">(</span><span style="color: #0A3069">' during development).</span><span style="color: #0550AE">\n</span><span style="color: #0A3069">'</span><span style="color: #24292F">)</span></li><li value="34"></li></ol></pre>
<p>
  It starts by observing the <code>verify</code> option and informing the Python library it uses for HTTPS interaction to turn off warnings.
  It displays a warning to users that they should be nervous about using this setting.
</p>
<pre class="snippet numbered"><ol class="snippet"><li value="35"><span style="color: #24292F">    </span><span style="color: #6E7781"># From: https://gist.github.com/butla/2d9a4c0f35ea47b7452156c96a4e7b12</span></li><li value="36"><span style="color: #24292F">    start_time </span><span style="color: #CF222E">=</span><span style="color: #24292F"> time.perf_counter()</span></li><li value="37"><span style="color: #24292F">    </span><span style="color: #CF222E">while</span><span style="color: #24292F"> </span><span style="color: #0550AE">True</span><span style="color: #24292F">:</span></li><li value="38"><span style="color: #24292F">        </span><span style="color: #CF222E">try</span><span style="color: #24292F">:</span></li><li value="39"><span style="color: #24292F">            </span><span style="color: #CF222E">with</span><span style="color: #24292F"> socket.create_connection((host, port), </span><span style="color: #953800">timeout</span><span style="color: #CF222E">=</span><span style="color: #24292F">timeout):</span></li><li value="40"><span style="color: #24292F">                </span><span style="color: #CF222E">break</span></li><li value="41"><span style="color: #24292F">        </span><span style="color: #CF222E">except</span><span style="color: #24292F"> </span><span style="color: #0550AE">OSError</span><span style="color: #24292F"> </span><span style="color: #CF222E">as</span><span style="color: #24292F"> ex:</span></li><li value="42"><span style="color: #24292F">            time.sleep(</span><span style="color: #0550AE">0.01</span><span style="color: #24292F">)</span></li><li value="43"><span style="color: #24292F">            </span><span style="color: #CF222E">if</span><span style="color: #24292F"> time.perf_counter() </span><span style="color: #CF222E">-</span><span style="color: #24292F"> start_time </span><span style="color: #CF222E">&gt;=</span><span style="color: #24292F"> timeout:</span></li><li value="44"><span style="color: #24292F">                </span><span style="color: #CF222E">raise</span><span style="color: #24292F"> </span><span style="color: #0550AE">TimeoutError</span><span style="color: #24292F">(</span><span style="color: #0A3069">'Waited too long for the port </span><span style="color: #0550AE">{}</span><span style="color: #0A3069"> '</span></li><li value="45"><span style="color: #24292F">                                   </span><span style="color: #0A3069">'on host </span><span style="color: #0550AE">{}</span><span style="color: #0A3069"> to accept connection.'</span></li><li value="46"><span style="color: #24292F">                                   .format(port, host)) </span><span style="color: #CF222E">from</span><span style="color: #24292F"> ex</span></li><li value="47"></li></ol></pre>
<p>Next, it attempts to connect to the Reach RPC Server and throws an error if it does not respond quickly enough.</p>
<pre class="snippet numbered"><ol class="snippet"><li value="52"><span style="color: #24292F">    </span><span style="color: #CF222E">def</span><span style="color: #24292F"> </span><span style="color: #8250DF">rpc</span><span style="color: #24292F">(m, </span><span style="color: #CF222E">*</span><span style="color: #24292F">args):</span></li><li value="53"><span style="color: #24292F">        lab </span><span style="color: #CF222E">=</span><span style="color: #24292F"> </span><span style="color: #0A3069">'RPC </span><span style="color: #0550AE">%s</span><span style="color: #0A3069"> </span><span style="color: #0550AE">%s</span><span style="color: #0A3069">'</span><span style="color: #24292F"> </span><span style="color: #CF222E">%</span><span style="color: #24292F"> (m, json.dumps([</span><span style="color: #CF222E">*</span><span style="color: #24292F">args]))</span></li><li value="54"><span style="color: #24292F">        debug(lab)</span></li><li value="55"><span style="color: #24292F">        ans </span><span style="color: #CF222E">=</span><span style="color: #24292F"> requests.post(</span><span style="color: #0A3069">'https://</span><span style="color: #0550AE">%s</span><span style="color: #0A3069">:</span><span style="color: #0550AE">%s%s</span><span style="color: #0A3069">'</span><span style="color: #24292F"> </span><span style="color: #CF222E">%</span><span style="color: #24292F"> (host, port, m),</span></li><li value="56"><span style="color: #24292F">                            </span><span style="color: #953800">json</span><span style="color: #24292F">    </span><span style="color: #CF222E">=</span><span style="color: #24292F"> [</span><span style="color: #CF222E">*</span><span style="color: #24292F">args],</span></li><li value="57"><span style="color: #24292F">                            </span><span style="color: #953800">headers</span><span style="color: #24292F"> </span><span style="color: #CF222E">=</span><span style="color: #24292F"> {</span><span style="color: #0A3069">'X-API-Key'</span><span style="color: #24292F">: key},</span></li><li value="58"><span style="color: #24292F">                            </span><span style="color: #953800">verify</span><span style="color: #24292F">  </span><span style="color: #CF222E">=</span><span style="color: #24292F"> verify)</span></li><li value="59"><span style="color: #24292F">        ans.raise_for_status()</span></li><li value="60"><span style="color: #24292F">        debug(</span><span style="color: #0A3069">'</span><span style="color: #0550AE">%s</span><span style="color: #0A3069"> ==&gt; </span><span style="color: #0550AE">%s</span><span style="color: #0A3069">'</span><span style="color: #24292F"> </span><span style="color: #CF222E">%</span><span style="color: #24292F"> (lab, json.dumps(ans.json())))</span></li><li value="61"><span style="color: #24292F">        </span><span style="color: #CF222E">return</span><span style="color: #24292F"> ans.json()</span></li><li value="62"></li></ol></pre>
<p>
  It defines a function, <code>rpc</code>, which will be returned later on, that
  implements the protocol for synchronous value RPC methods.
  It formats a given request, posts it, and then returns the deserialized result.
  It prints debugging information for convenience.
</p>
<pre class="snippet numbered"><ol class="snippet"><li value="63"><span style="color: #24292F">    </span><span style="color: #CF222E">def</span><span style="color: #24292F"> </span><span style="color: #8250DF">rpc_callbacks</span><span style="color: #24292F">(m, arg, cbacks):</span></li><li value="64"><span style="color: #24292F">        vals  </span><span style="color: #CF222E">=</span><span style="color: #24292F"> {k: v    </span><span style="color: #CF222E">for</span><span style="color: #24292F"> k, v </span><span style="color: #CF222E">in</span><span style="color: #24292F"> cbacks.items() </span><span style="color: #CF222E">if</span><span style="color: #24292F"> </span><span style="color: #CF222E">not</span><span style="color: #24292F"> </span><span style="color: #0550AE">callable</span><span style="color: #24292F">(v)}</span></li><li value="65"><span style="color: #24292F">        meths </span><span style="color: #CF222E">=</span><span style="color: #24292F"> {k: </span><span style="color: #0550AE">True</span><span style="color: #24292F"> </span><span style="color: #CF222E">for</span><span style="color: #24292F"> k, v </span><span style="color: #CF222E">in</span><span style="color: #24292F"> cbacks.items() </span><span style="color: #CF222E">if</span><span style="color: #24292F">     </span><span style="color: #0550AE">callable</span><span style="color: #24292F">(v)}</span></li><li value="66"><span style="color: #24292F">        p     </span><span style="color: #CF222E">=</span><span style="color: #24292F"> rpc(m, arg, vals, meths)</span></li><li value="67"></li><li value="68"><span style="color: #24292F">        </span><span style="color: #CF222E">while</span><span style="color: #24292F"> </span><span style="color: #0550AE">True</span><span style="color: #24292F">:</span></li><li value="69"><span style="color: #24292F">            </span><span style="color: #CF222E">if</span><span style="color: #24292F"> p[</span><span style="color: #0A3069">'t'</span><span style="color: #24292F">] </span><span style="color: #CF222E">==</span><span style="color: #24292F"> </span><span style="color: #0A3069">'Done'</span><span style="color: #24292F">:</span></li><li value="70"><span style="color: #24292F">                </span><span style="color: #CF222E">return</span><span style="color: #24292F"> p</span></li><li value="71"></li><li value="72"><span style="color: #24292F">            </span><span style="color: #CF222E">elif</span><span style="color: #24292F"> p[</span><span style="color: #0A3069">'t'</span><span style="color: #24292F">] </span><span style="color: #CF222E">==</span><span style="color: #24292F"> </span><span style="color: #0A3069">'Kont'</span><span style="color: #24292F">:</span></li><li value="73"><span style="color: #24292F">                cback </span><span style="color: #CF222E">=</span><span style="color: #24292F"> cbacks[p[</span><span style="color: #0A3069">'m'</span><span style="color: #24292F">]]</span></li><li value="74"><span style="color: #24292F">                ans   </span><span style="color: #CF222E">=</span><span style="color: #24292F"> cback(</span><span style="color: #CF222E">*</span><span style="color: #24292F">p[</span><span style="color: #0A3069">'args'</span><span style="color: #24292F">])</span></li><li value="75"><span style="color: #24292F">                p     </span><span style="color: #CF222E">=</span><span style="color: #24292F"> rpc(</span><span style="color: #0A3069">'/kont'</span><span style="color: #24292F">, p[</span><span style="color: #0A3069">'kid'</span><span style="color: #24292F">], ans)</span></li><li value="76"></li><li value="77"><span style="color: #24292F">            </span><span style="color: #CF222E">else</span><span style="color: #24292F">:</span></li><li value="78"><span style="color: #24292F">                </span><span style="color: #CF222E">raise</span><span style="color: #24292F"> </span><span style="color: #0550AE">Exception</span><span style="color: #24292F">(</span><span style="color: #0A3069">'Illegal callback return: </span><span style="color: #0550AE">%s</span><span style="color: #0A3069">'</span><span style="color: #24292F"> </span><span style="color: #CF222E">%</span><span style="color: #24292F"> json.dumps(p))</span></li><li value="79"></li></ol></pre>
<p>
  It defines a function, <code>rpc_callbacks</code>, which will be returned later on, that
  implements the protocol for interactive RPC methods.
  On lines 64 and 65, this function inspects its third argument, <code>cbacks</code>,
  and separates the <code>callable</code> arguments from the values and creates the
  intermediate objects, <code>vals</code> and <code>meths</code>, to provide the RPC
  invocation.
  After it makes the call, in the <code>while</code> loop starting on line 68, it
  inspects the result to determine if it is a final answer or an
  interactive RPC callback.
  If it is a callback, as indicated by the test on line 72, then it extracts the
  name of the method, <code>p['m']</code>, and invokes it in the original third
  argument, <code>cbacks</code>, with the provided arguments.
  It replaces the <code>p</code> value with the result of that continuation invocation and continues.
</p>
<pre class="snippet numbered"><ol class="snippet"><li value="80"><span style="color: #24292F">    </span><span style="color: #CF222E">return</span><span style="color: #24292F"> rpc, rpc_callbacks</span></li></ol></pre>
<p>Finally, it returns <code>rpc</code> and <code>rpc_callbacks</code> to the user.</p>